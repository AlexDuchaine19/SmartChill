[
    {
        "id": "login_tab",
        "type": "tab",
        "label": "SmartChill Authentication",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "dashboard_tab",
        "type": "tab",
        "label": "SmartChill Dashboard",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "5dc8affbd505959b",
        "type": "tab",
        "label": "Admin Dashboard",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "ui_base",
        "type": "ui-base",
        "name": "SmartChill Dashboard",
        "path": "/dashboard",
        "appIcon": "",
        "includeClientData": true,
        "acceptsClientConfig": [
            "ui-notification",
            "ui-control"
        ],
        "showPathInSidebar": false,
        "headerContent": "page",
        "titleBarStyle": "default",
        "showReconnectNotification": true,
        "notificationDisplayTime": 5,
        "showDisconnectNotification": true,
        "allowInstall": true
    },
    {
        "id": "4b2a3a4787640bee",
        "type": "ui-theme",
        "name": "Theme Name",
        "colors": {
            "surface": "#ffffff",
            "primary": "#0094ce",
            "bgPage": "#eeeeee",
            "groupBg": "#ffffff",
            "groupOutline": "#cccccc"
        },
        "sizes": {
            "density": "default",
            "pagePadding": "12px",
            "groupGap": "12px",
            "groupBorderRadius": "4px",
            "widgetGap": "12px"
        }
    },
    {
        "id": "login_page",
        "type": "ui-page",
        "name": "SmartChill Login",
        "ui": "ui_base",
        "path": "/login",
        "icon": "home",
        "layout": "grid",
        "theme": "4b2a3a4787640bee",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 1,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "870fbc0c32558fca",
        "type": "ui-group",
        "name": "Login",
        "page": "login_page",
        "width": 12,
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "dashboard_page",
        "type": "ui-page",
        "name": "SmartChill Dashboard",
        "ui": "ui_base",
        "path": "/home",
        "icon": "dashboard",
        "layout": "grid",
        "theme": "4b2a3a4787640bee",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 2,
        "className": "",
        "visible": "true",
        "disabled": "false"
    },
    {
        "id": "hero_group",
        "type": "ui-group",
        "name": "Panoramica Dispositivo",
        "page": "dashboard_page",
        "width": 12,
        "height": 1,
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "cae7e64b62c3d84e",
        "type": "mqtt-broker",
        "name": "SmartChill MQTT",
        "broker": "mosquitto",
        "port": "1883",
        "clientid": "nodered_dashboard",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true
    },
    {
        "id": "55fad598fbd6a397",
        "type": "ui-spacer",
        "group": "hero_group",
        "name": "spacer",
        "tooltip": "",
        "order": 8,
        "width": 2,
        "height": 2,
        "className": ""
    },
    {
        "id": "36433955d1ce23fa",
        "type": "ui-spacer",
        "group": "hero_group",
        "name": "spacer",
        "tooltip": "",
        "order": 11,
        "width": 2,
        "height": 11,
        "className": ""
    },
    {
        "id": "8506a52686562f64",
        "type": "ui-spacer",
        "group": "hero_group",
        "name": "spacer",
        "tooltip": "",
        "order": 2,
        "width": 1,
        "height": 1,
        "className": ""
    },
    {
        "id": "417e88c91a3172ea",
        "type": "ui-page",
        "name": "SmartChill Settings",
        "ui": "ui_base",
        "path": "/settings",
        "icon": "con",
        "layout": "grid",
        "theme": "4b2a3a4787640bee",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 3,
        "className": "body, .v-application {   background-color: #fafbfc !important; }",
        "visible": true,
        "disabled": false
    },
    {
        "id": "58fd4ecb3e5a8e5e",
        "type": "ui-group",
        "name": "Time Service Settings",
        "page": "417e88c91a3172ea",
        "width": "12",
        "height": "3",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "60a56c41d4be3619",
        "type": "ui-spacer",
        "group": "58fd4ecb3e5a8e5e",
        "name": "spacer",
        "tooltip": "",
        "order": 7,
        "width": 3,
        "height": 3,
        "className": ""
    },
    {
        "id": "64e7c00a16661f0d",
        "type": "ui-spacer",
        "group": "58fd4ecb3e5a8e5e",
        "name": "spacer",
        "tooltip": "",
        "order": 9,
        "width": 2,
        "height": 1,
        "className": ""
    },
    {
        "id": "2d88d8bcdecc2234",
        "type": "ui-spacer",
        "group": "870fbc0c32558fca",
        "name": "spacer",
        "tooltip": "",
        "order": 1,
        "width": 12,
        "height": 3,
        "className": ""
    },
    {
        "id": "8727a506e0609ba5",
        "type": "ui-spacer",
        "group": "870fbc0c32558fca",
        "name": "spacer",
        "tooltip": "",
        "order": 2,
        "width": 5,
        "height": 11,
        "className": ""
    },
    {
        "id": "fccb29c53f60fd0e",
        "type": "ui-page",
        "name": "Admin Dashboard",
        "ui": "ui_base",
        "path": "/admin",
        "icon": "home",
        "layout": "grid",
        "theme": "4b2a3a4787640bee",
        "breakpoints": [
            {
                "name": "Default",
                "px": "0",
                "cols": "3"
            },
            {
                "name": "Tablet",
                "px": "576",
                "cols": "6"
            },
            {
                "name": "Small Desktop",
                "px": "768",
                "cols": "9"
            },
            {
                "name": "Desktop",
                "px": "1024",
                "cols": "12"
            }
        ],
        "order": 4,
        "className": "",
        "visible": true,
        "disabled": false
    },
    {
        "id": "9c3a47613a75c26f",
        "type": "ui-group",
        "name": "Overview Devices",
        "page": "fccb29c53f60fd0e",
        "width": "16",
        "height": "10",
        "order": 1,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "cd8cdd43a349e446",
        "type": "ui-group",
        "name": "Overview Services",
        "page": "fccb29c53f60fd0e",
        "width": "16",
        "height": "10",
        "order": 2,
        "showTitle": false,
        "className": "",
        "visible": "true",
        "disabled": "false",
        "groupType": "default"
    },
    {
        "id": "login_form",
        "type": "ui-form",
        "z": "login_tab",
        "name": "SmartChill Login",
        "group": "870fbc0c32558fca",
        "label": "",
        "order": 3,
        "width": "2",
        "height": "4",
        "options": [
            {
                "label": "User Name",
                "key": "username",
                "type": "text",
                "required": true,
                "rows": null
            },
            {
                "label": "MAC Address Device (ex: AA:BB:CC:DD:EE:FF)",
                "key": "mac_address",
                "type": "text",
                "required": true,
                "rows": null
            }
        ],
        "formValue": {
            "username": "",
            "mac_address": ""
        },
        "payload": "",
        "submit": "Login / Register",
        "cancel": "Clear",
        "resetOnSubmit": true,
        "topic": "login_attempt",
        "topicType": "str",
        "splitLayout": false,
        "className": "",
        "dropdownOptions": [],
        "x": 200,
        "y": 100,
        "wires": [
            [
                "validate_input",
                "24013fa3e94a8cf1"
            ]
        ]
    },
    {
        "id": "validate_input",
        "type": "function",
        "z": "login_tab",
        "name": "Validate Input & Generate Device ID",
        "func": "// Extract form data\nconst username = msg.payload.username || '';\nconst macAddress = msg.payload.mac_address || '';\n\n// Caso speciale: login admin\nif (username.trim() === \"admin\" && macAddress.trim() === \"admin\") {\n    const adminMsg = {\n        payload: \"Admin Dashboard\"   // üëà nome della pagina che deve aprire ui_control\n    };\n    return [null, null, adminMsg];   // esce dalla 3¬™ uscita\n}\n\n// Validate input format\nif (!username.trim()) {\n    msg.payload = \"‚ùå Username required!\";\n    msg.ui_update = {\n        color: \"red\",\n        position: \"top center\",\n        displayTime: 5,\n        showCountdown: true,\n        allowDismiss: true,\n        allowConfirm: false,\n        raw: true\n    };\n    return [null, msg, null];   // esce dalla 2¬™ uscita (errore)\n}\n\n// Validate MAC address format (basic check)\nconst macRegex = /^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/;\nif (!macRegex.test(macAddress)) {\n    msg.payload = \"‚ö†Ô∏è Invalid MAC Address format.<br>Use format <b>AA:BB:CC:DD:EE:FF</b>\";\n    msg.ui_update = {\n        color: \"orange\",\n        position: \"top center\",\n        displayTime: 7,\n        showCountdown: true,\n        allowDismiss: true,\n        allowConfirm: false,\n        raw: true\n    };\n    return [null, msg, null];   // esce dalla 2¬™ uscita (errore)\n}\n\n// Generate device_id from full MAC (remove ':' or '-')\nconst cleanMac = macAddress.replace(/[:-]/g, '').toUpperCase();\nconst deviceId = `SmartChill_${cleanMac}`;\n\n// Store in flow context\nflow.set('current_username', username.trim());\nflow.set('current_mac', macAddress.toUpperCase());\nflow.set('current_device_id', deviceId);\n\n// Prepare for device existence check\nmsg.payload = {\n    username: username.trim(),\n    mac_address: macAddress.toUpperCase(),\n    device_id: deviceId\n};\n\nmsg.url = `http://catalog:8001/devices/${deviceId}/exists`;\nmsg.method = 'GET';\n\n// Uscita 1 ‚Üí richiesta HTTP\nreturn [msg, null, null];",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 100,
        "wires": [
            [
                "check_device_exists"
            ],
            [
                "show_message"
            ],
            [
                "0c4a9c34fed3fc32",
                "d56205248b8bf587"
            ]
        ],
        "outputLabels": [
            "",
            "",
            "Admin Page"
        ]
    },
    {
        "id": "check_device_exists",
        "type": "http request",
        "z": "login_tab",
        "name": "Check Device Exists",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 760,
        "y": 80,
        "wires": [
            [
                "process_device_check",
                "367f6ae8ae9db5d8"
            ]
        ]
    },
    {
        "id": "process_device_check",
        "type": "function",
        "z": "login_tab",
        "name": "Process Device Check",
        "func": "const deviceId = flow.get('current_device_id');\nconst username = flow.get('current_username');\nconst macAddress = flow.get('current_mac');\n\n// Check if device exists\nif (!msg.payload.exists) {\n    msg.payload = `‚ö†Ô∏è Device <b>${deviceId}</b> not found.<br>\n    Please power on the device first and wait for automatic registration.`;\n\n    msg.ui_update = {\n        color: \"orange\",\n        position: \"top center\",\n        displayTime: 8,\n        showCountdown: true,\n        allowDismiss: true,\n        allowConfirm: false,\n        raw: true    // permette di interpretare il payload come HTML\n    };\n\n    return [null, msg];\n}\n\n// Device exists, ora controlliamo se √® gi√† assegnato\nmsg.url = `http://catalog:8001/devices/${deviceId}`;\nmsg.method = \"GET\";\n\nreturn [msg, null];\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 140,
        "wires": [
            [
                "check_device_assigned"
            ],
            [
                "show_message"
            ]
        ],
        "outputLabels": [
            "Procede",
            "Errore"
        ]
    },
    {
        "id": "check_device_assigned",
        "type": "http request",
        "z": "login_tab",
        "name": "Get Device Details",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1180,
        "y": 100,
        "wires": [
            [
                "check_assignment_status",
                "a5e16fe980067e78"
            ]
        ]
    },
    {
        "id": "check_assignment_status",
        "type": "function",
        "z": "login_tab",
        "name": "Check Assignment Status",
        "func": "const deviceId = flow.get('current_device_id');\nconst username = flow.get('current_username');\nconst userId = username.toLowerCase();\nconst device = msg.payload;\n\n// Caso 1: device non trovato ‚Üí errore (uscita 1)\nif (device.user_assigned === true && device.assigned_user &&\n    device.assigned_user.toLowerCase() !== userId) {\n    msg.payload = `‚ùå Device <code>${deviceId}</code> is already associated with an account.`;\n    msg.ui_update = {\n        color: \"red\",\n        position: \"top center\",\n        displayTime: 6,\n        showCountdown: true,\n        allowDismiss: true,\n        raw: true\n    };\n    return [msg, null, null];\n}\n\n// Caso 2: device non assegnato ‚Üí associazione (uscita 2)\nif (device.user_assigned === false) {\n    msg.payload = {\n        userID: userId,\n        userName: username,\n        deviceId: deviceId\n    };\n    msg.headers = { \"content-type\": \"application/json\" };\n    msg.url = \"http://catalog:8001/users\";\n    msg.method = \"POST\";\n    return [null, msg, null];\n}\n\n// Caso 3: device assegnato a QUESTO utente ‚Üí login diretto (uscita 3)\nif (device.user_assigned === true && device.assigned_user &&\n    device.assigned_user.toLowerCase() === userId) {\n\n    msg.payload = {\n        userID: userId,\n        userName: username,\n        deviceId: deviceId\n    };\n    return [null, null, msg];\n}",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1450,
        "y": 100,
        "wires": [
            [
                "show_message",
                "c28ada6b827d663b"
            ],
            [
                "create_user"
            ],
            [
                "login_success",
                "5eb354f586f5a4c0"
            ]
        ],
        "outputLabels": [
            "Errore",
            "Associazione",
            "Login"
        ]
    },
    {
        "id": "create_user",
        "type": "http request",
        "z": "login_tab",
        "name": "Create User",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Content-Type",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 1700,
        "y": 100,
        "wires": [
            [
                "assign_device_to_user"
            ]
        ]
    },
    {
        "id": "assign_device_to_user",
        "type": "function",
        "z": "login_tab",
        "name": "Prepare Device Assignment",
        "func": "const deviceId = flow.get('current_device_id');\nconst username = flow.get('current_username');\nconst userId = username.toLowerCase();\n\n// Prepare device assignment payload\nmsg.payload = {\n    device_id: deviceId,\n    device_name: `${username}'s Fridge`\n};\n\nmsg.url = `http://catalog:8001/users/${userId}/assign-device`;\nmsg.method = 'POST';\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1950,
        "y": 100,
        "wires": [
            [
                "assign_device",
                "5ae65204e93eb35a"
            ]
        ]
    },
    {
        "id": "assign_device",
        "type": "http request",
        "z": "login_tab",
        "name": "Assign Device",
        "method": "POST",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [
            {
                "keyType": "other",
                "keyValue": "Content-Type",
                "valueType": "other",
                "valueValue": "application/json"
            }
        ],
        "x": 2200,
        "y": 100,
        "wires": [
            [
                "login_success"
            ]
        ]
    },
    {
        "id": "login_success",
        "type": "function",
        "z": "login_tab",
        "name": "Login Success",
        "func": "const deviceId = flow.get('current_device_id');\nconst username = flow.get('current_username');\nconst userId = username.toLowerCase();\n\n// Store user session in global context\nglobal.set('user_session', {\n    userId: userId,\n    userName: username,\n    deviceId: deviceId,\n    loginTime: new Date().toISOString(),\n    isAuthenticated: true\n});\n\n// Show success message (notification)\nmsg.payload = `‚úÖ Login successful!<br>\nWelcome <b>${username}</b> üéâ<br>\nYour device <code>${deviceId}</code> has been successfully associated.`;\n\nmsg.ui_update = {\n    color: \"green\",\n    position: \"top center\",\n    displayTime: 1,\n    showCountdown: true,\n    allowDismiss: true,\n    allowConfirm: false,\n    raw: true    // üëà abilita HTML\n};\n\n// Se vuoi gestire anche il redirect, aggiungi un flag separato\nmsg.redirect = true;\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2060,
        "y": 180,
        "wires": [
            [
                "show_message",
                "redirect_to_dashboard"
            ]
        ]
    },
    {
        "id": "show_message",
        "type": "ui-notification",
        "z": "login_tab",
        "ui": "ui_base",
        "position": "top right",
        "colorDefault": true,
        "color": "#1f93ff",
        "displayTime": "5",
        "showCountdown": true,
        "outputs": 1,
        "allowDismiss": true,
        "dismissText": "Close",
        "allowConfirm": false,
        "confirmText": "",
        "raw": false,
        "className": "",
        "name": "Show Message",
        "x": 1920,
        "y": 260,
        "wires": [
            []
        ]
    },
    {
        "id": "redirect_to_dashboard",
        "type": "function",
        "z": "login_tab",
        "name": "Enable Dashboard Access",
        "func": "// Set flag to enable dashboard navigation\nglobal.set('dashboard_access_enabled', true);\n\n// Send message to dashboard tab to refresh/show content\nmsg.payload = {\n    command: 'user_logged_in',\n    user: global.get('user_session')\n};\n\nmsg.topic = 'user_login';\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2340,
        "y": 200,
        "wires": [
            [
                "dashboard_init"
            ]
        ]
    },
    {
        "id": "dashboard_init",
        "type": "link out",
        "z": "login_tab",
        "name": "to_dashboard",
        "mode": "link",
        "links": [
            "99841df56f96cef2"
        ],
        "x": 2545,
        "y": 200,
        "wires": []
    },
    {
        "id": "check_auth_on_startup",
        "type": "inject",
        "z": "login_tab",
        "name": "Check Auth on Startup",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "{\"pages\":{\"hide\":[\"SmartChill Dashboard\",\"Admin Dashboard\",\"SmartChill Settings\"]},\"page\":\"SmartChill Login\"}",
        "payloadType": "json",
        "x": 200,
        "y": 300,
        "wires": [
            [
                "f8fa6781c0dcb5df"
            ]
        ]
    },
    {
        "id": "a5e16fe980067e78",
        "type": "debug",
        "z": "login_tab",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1400,
        "y": 40,
        "wires": []
    },
    {
        "id": "24013fa3e94a8cf1",
        "type": "debug",
        "z": "login_tab",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 400,
        "y": 180,
        "wires": []
    },
    {
        "id": "6adf025f888e587d",
        "type": "comment",
        "z": "login_tab",
        "name": "A4:B2:C3:D9:1E:7F",
        "info": "",
        "x": 470,
        "y": 400,
        "wires": []
    },
    {
        "id": "367f6ae8ae9db5d8",
        "type": "debug",
        "z": "login_tab",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 960,
        "y": 80,
        "wires": []
    },
    {
        "id": "c28ada6b827d663b",
        "type": "debug",
        "z": "login_tab",
        "name": "debug 5",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1700,
        "y": 40,
        "wires": []
    },
    {
        "id": "99841df56f96cef2",
        "type": "link in",
        "z": "login_tab",
        "name": "From Login",
        "links": [
            "dashboard_init"
        ],
        "x": 935,
        "y": 320,
        "wires": [
            [
                "eb544e8e2a4704cd"
            ]
        ]
    },
    {
        "id": "eb544e8e2a4704cd",
        "type": "function",
        "z": "login_tab",
        "name": "Handle Access",
        "func": "const session = global.get('user_session');\nconst access = global.get('dashboard_access_enabled') || false;\n\nif (!access || !session) {\n    // Errore ‚Üí uscita 1 (notifica)\n    msg.payload = \"‚õî Accesso non autorizzato. Effettua prima il login.\";\n    msg.ui_update = {\n        color: \"red\",\n        position: \"top center\",\n        displayTime: 6,\n        showCountdown: true,\n        allowDismiss: true,\n        raw: true\n    };\n    return [msg, null];\n}\n\n// Se accesso valido ‚Üí uscita 2 (cambio tab)\nmsg.payload = \"SmartChill Dashboard\";   // üëà questo apre la pagina\nreturn [null, msg];",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1120,
        "y": 320,
        "wires": [
            [
                "show_message"
            ],
            [
                "b192571ced4283ce"
            ]
        ]
    },
    {
        "id": "7e4693f5248d0725",
        "type": "ui-control",
        "z": "login_tab",
        "name": "",
        "ui": "ui_base",
        "events": "all",
        "x": 1440,
        "y": 380,
        "wires": [
            []
        ]
    },
    {
        "id": "f8fa6781c0dcb5df",
        "type": "ui-control",
        "z": "login_tab",
        "name": "",
        "ui": "ui_base",
        "events": "all",
        "x": 400,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "5eb354f586f5a4c0",
        "type": "debug",
        "z": "login_tab",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1640,
        "y": 180,
        "wires": []
    },
    {
        "id": "b192571ced4283ce",
        "type": "delay",
        "z": "login_tab",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1260,
        "y": 380,
        "wires": [
            [
                "7e4693f5248d0725"
            ]
        ]
    },
    {
        "id": "3e29abd2b0df0b4b",
        "type": "comment",
        "z": "login_tab",
        "name": "3C:5A:B4:9F:2D:71",
        "info": "",
        "x": 250,
        "y": 400,
        "wires": []
    },
    {
        "id": "0c4a9c34fed3fc32",
        "type": "ui-control",
        "z": "login_tab",
        "name": "Admin Dashboard",
        "ui": "ui_base",
        "events": "all",
        "x": 710,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "d56205248b8bf587",
        "type": "link out",
        "z": "login_tab",
        "name": "From Admin Login",
        "mode": "link",
        "links": [
            "c649be102a5dffe5"
        ],
        "x": 675,
        "y": 240,
        "wires": []
    },
    {
        "id": "5ae65204e93eb35a",
        "type": "debug",
        "z": "login_tab",
        "name": "debug 15",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2120,
        "y": 60,
        "wires": []
    },
    {
        "id": "3a7e454ba0d63032",
        "type": "comment",
        "z": "login_tab",
        "name": "Use one of this two as valid MAC Addresses",
        "info": "",
        "x": 450,
        "y": 460,
        "wires": []
    },
    {
        "id": "dashboard_receiver",
        "type": "link in",
        "z": "dashboard_tab",
        "name": "Dashboard Init",
        "links": [
            "dashboard_init"
        ],
        "x": 95,
        "y": 40,
        "wires": [
            [
                "update_hero_data",
                "67863dc1b3cd63e5",
                "aab43d097f269a33",
                "87c3519ce88d036e"
            ]
        ]
    },
    {
        "id": "update_hero_data",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Update Hero Data",
        "func": "const userSession = global.get('user_session');\n\nif (!userSession || !userSession.isAuthenticated) {\n    return null;\n}\n\nmsg.payload = {\n    userName: userSession.userName,\n    deviceId: userSession.deviceId,\n    deviceName: `${userSession.userName}'s Fridge`,\n    lastSync: new Date().toLocaleString('it-IT'),\n    status: 'online',\n    temperature: '--',\n    energy: '--',\n    doorOpenings: '--'\n};\n\nmsg.topic = 'hero_update';\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 300,
        "y": 100,
        "wires": [
            [
                "hero_template",
                "fetch_current_data"
            ]
        ]
    },
    {
        "id": "hero_template",
        "type": "ui-template",
        "z": "dashboard_tab",
        "group": "hero_group",
        "page": "",
        "ui": "",
        "name": "Hero Section",
        "order": 1,
        "width": "",
        "height": "",
        "format": "<link href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" rel=\"stylesheet\">\n\n<div class=\"smch-hero-container\">\n    <div class=\"smch-hero-header\">\n        <div class=\"smch-device-info\">\n            <div class=\"smch-device-icon\" aria-hidden=\"true\">\n                <i class=\"material-icons\">kitchen</i>\n            </div>\n            <div class=\"smch-device-details\">\n                <h2 class=\"smch-device-name\">{{msg.payload.deviceName || 'My Fridge'}}</h2>\n                <p class=\"smch-device-id\">{{msg.payload.deviceId || 'SmartChill_000000'}}</p>\n\n                <div class=\"smch-status-badge\" data-status=\"{{(msg.payload.status || 'offline')}}\">\n                    <span class=\"smch-status-dot\"></span>\n                    <span class=\"smch-status-text\">{{(msg.payload.status || 'Offline')}}</span>\n                </div>\n\n            </div>\n        </div>\n\n        <div class=\"smch-user-info\">\n            <div class=\"smch-user-icon\" aria-hidden=\"true\">\n                <i class=\"material-icons\">account_circle</i>\n            </div>\n            <div class=\"smch-user-details\">\n                <div class=\"smch-welcome-text\">\n                    <span>Welcome,</span>\n                    <strong>{{msg.payload.userName || 'User'}}</strong>\n                </div>\n                <div class=\"smch-last-sync\">\n                    <i class=\"material-icons\">sync</i>\n                    <span>Last updated: {{msg.payload.lastSync || '--/--/---- --:--'}}</span>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <div class=\"smch-quick-stats\">\n        <div class=\"smch-stat-card smch-temperature\">\n            <div class=\"smch-stat-icon\" aria-hidden=\"true\">\n                <i class=\"material-icons\">thermostat</i>\n            </div>\n            <div class=\"smch-stat-content\">\n                <div class=\"smch-stat-value\">\n                    {{ (msg.payload.temperature !== undefined && msg.payload.temperature !== null) ?\n                    msg.payload.temperature : '--' }}<span class=\"smch-unit\">¬∞C</span>\n                </div>\n                <div class=\"smch-stat-label\">Temperature</div>\n            </div>\n        </div>\n\n        <div class=\"smch-stat-card smch-gas\">\n            <div class=\"smch-stat-icon\" aria-hidden=\"true\">\n                <i class=\"material-icons\">air</i>\n            </div>\n            <div class=\"smch-stat-content\">\n                <div class=\"smch-stat-value\">\n                    {{ (msg.payload.gas !== undefined && msg.payload.gas !== null) ? msg.payload.gas : '--' }}\n                    <span class=\"smch-unit\">ppm</span>\n                </div>\n                <div class=\"smch-stat-label\">Air Quality (Gas)</div>\n            </div>\n        </div>\n\n        <div class=\"smch-stat-card smch-humidity\">\n            <div class=\"smch-stat-icon\" aria-hidden=\"true\">\n                <i class=\"material-icons\">water_drop</i>\n            </div>\n            <div class=\"smch-stat-content\">\n                <div class=\"smch-stat-value\">\n                    {{ (msg.payload.humidity !== undefined && msg.payload.humidity !== null) ? msg.payload.humidity :\n                    '--' }}\n                    <span class=\"smch-unit\">%RH</span>\n                </div>\n                <div class=\"smch-stat-label\">Humidity</div>\n            </div>\n        </div>\n    </div>\n</div>\n\n<style>\n    /* === Variabili Colori (Tema Chiaro Professionale) === */\n    :root {\n        --smch-panel-bg: #f5f8fc;\n        --smch-bg-color: #ffffff;\n        --smch-text-primary: #1a2e3b;\n        --smch-text-secondary: #5a7184;\n        --smch-border-color: #eaf0f8;\n        --smch-status-online-bg: #e8f5e9;\n        --smch-status-online-text: #388e3c;\n        --smch-status-offline-bg: #ffebee;\n        --smch-status-offline-text: #d32f2f;\n        --smch-temp-bg: #fff8e1;\n        --smch-temp-icon: #f57f17;\n        --smch-gas-bg: #e8f5e9;\n        --smch-gas-icon: #388e3c;\n        --smch-hum-bg: #e3f2fd;\n        --smch-hum-icon: #1e88e5;\n        --smch-shadow: 0 4px 12px rgba(90, 113, 132, 0.08);\n    }\n\n    /* === Classi Uniche === */\n    .smch-hero-container {\n        background: var(--smch-panel-bg);\n        border: 1px solid var(--smch-border-color);\n        border-radius: 12px;\n        padding: 24px;\n        color: var(--smch-text-primary);\n        margin-bottom: 16px;\n        box-shadow: var(--smch-shadow);\n        width: 100%;\n        box-sizing: border-box;\n    }\n\n    .smch-hero-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: flex-start;\n        gap: 16px;\n        flex-wrap: wrap;\n        margin-bottom: 24px;\n        padding-bottom: 20px;\n        border-bottom: 1px solid var(--smch-border-color);\n    }\n\n    .smch-device-info {\n        display: flex;\n        align-items: center;\n        gap: 16px;\n        flex: 1;\n        min-width: 280px;\n    }\n\n    .smch-device-icon {\n        background: var(--smch-bg-color);\n        border: 1px solid var(--smch-border-color);\n        border-radius: 50%;\n        width: 56px;\n        height: 56px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n    }\n\n    .smch-device-icon i {\n        font-size: 28px;\n        color: var(--smch-text-primary);\n    }\n\n    .smch-device-details h2 {\n        margin: 0 0 4px 0;\n        font-size: 24px;\n        font-weight: 600;\n        line-height: 1.2;\n    }\n\n    .smch-device-id {\n        margin: 0 0 10px 0;\n        color: var(--smch-text-secondary);\n        font-size: 13px;\n        font-family: monospace;\n    }\n\n    .smch-status-badge {\n        display: inline-flex;\n        align-items: center;\n        gap: 8px;\n        padding: 4px 10px;\n        border-radius: 999px;\n        font-size: 12px;\n        font-weight: 600;\n    }\n\n    .smch-status-badge .smch-status-dot {\n        width: 8px;\n        height: 8px;\n        border-radius: 50%;\n        display: inline-block;\n    }\n\n    /* CSS CORRETTO: \n      Il selettore [data-status=\"online\"]\n      corrisponder√† esattamente al valore 'online'\n      inviato dal tuo function node.\n    */\n    .smch-status-badge[data-status=\"online\"] {\n        background: var(--smch-status-online-bg);\n        color: var(--smch-status-online-text);\n    }\n\n    .smch-status-badge[data-status=\"online\"] .smch-status-dot {\n        background: var(--smch-status-online-text);\n    }\n\n    .smch-status-badge[data-status=\"offline\"] {\n        background: var(--smch-status-offline-bg);\n        color: var(--smch-status-offline-text);\n    }\n\n    .smch-status-badge[data-status=\"offline\"] .smch-status-dot {\n        background: var(--smch-status-offline-text);\n    }\n\n    /* CSS CORRETTO: \n      Applica lo stile 'uppercase' qui, \n      non nell'HTML.\n    */\n    .smch-status-text {\n        letter-spacing: 0.5px;\n        text-transform: uppercase;\n    }\n\n    .smch-user-info {\n        display: flex;\n        gap: 12px;\n        align-items: center;\n        flex-shrink: 0;\n        min-width: 220px;\n        justify-content: flex-end;\n    }\n\n    .smch-user-icon {\n        font-size: 40px;\n        color: var(--smch-text-secondary);\n        opacity: 0.8;\n    }\n\n    .smch-user-details {\n        text-align: right;\n    }\n\n    .smch-welcome-text {\n        font-size: 15px;\n        color: var(--smch-text-secondary);\n    }\n\n    .smch-welcome-text strong {\n        display: block;\n        font-size: 20px;\n        font-weight: 600;\n        color: var(--smch-text-primary);\n    }\n\n    .smch-last-sync {\n        display: flex;\n        align-items: center;\n        gap: 6px;\n        justify-content: flex-end;\n        color: var(--smch-text-secondary);\n        font-size: 12px;\n        margin-top: 4px;\n    }\n\n    .smch-last-sync i {\n        font-size: 14px;\n    }\n\n    .smch-quick-stats {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n        gap: 14px;\n        width: 100%;\n    }\n\n    .smch-stat-card {\n        background: var(--smch-bg-color);\n        border: 1px solid var(--smch-border-color);\n        border-radius: 12px;\n        padding: 18px;\n        display: flex;\n        align-items: center;\n        gap: 14px;\n        min-height: 86px;\n        transition: transform .18s ease, box-shadow .18s ease;\n    }\n\n    .smch-stat-card:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 6px 16px rgba(90, 113, 132, 0.1);\n    }\n\n    .smch-stat-icon {\n        border-radius: 50%;\n        width: 44px;\n        height: 44px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        flex-shrink: 0;\n    }\n\n    .smch-stat-icon i {\n        font-size: 22px;\n    }\n\n    .smch-stat-content {\n        flex: 1;\n        text-align: left;\n    }\n\n    .smch-stat-value {\n        font-size: 22px;\n        font-weight: 600;\n        margin-bottom: 3px;\n        line-height: 1;\n        color: var(--smch-text-primary);\n    }\n\n    .smch-unit {\n        font-size: .85rem;\n        font-weight: 500;\n        margin-left: 2px;\n        color: var(--smch-text-secondary);\n    }\n\n    .smch-stat-label {\n        color: var(--smch-text-secondary);\n        font-size: 13px;\n        line-height: 1;\n        font-weight: 500;\n    }\n\n    .smch-temperature .smch-stat-icon {\n        background: var(--smch-temp-bg);\n        color: var(--smch-temp-icon);\n    }\n\n    .smch-gas .smch-stat-icon {\n        background: var(--smch-gas-bg);\n        color: var(--smch-gas-icon);\n    }\n\n    .smch-humidity .smch-stat-icon {\n        background: var(--smch-hum-bg);\n        color: var(--smch-hum-icon);\n    }\n\n    /* Responsive */\n    @media (max-width: 768px) {\n        .smch-hero-header {\n            flex-direction: column;\n            align-items: flex-start;\n            gap: 20px;\n        }\n\n        .smch-user-info {\n            flex-direction: row-reverse;\n            justify-content: flex-start;\n            width: 100%;\n        }\n\n        .smch-user-details {\n            text-align: left;\n        }\n\n        .smch-last-sync {\n            justify-content: flex-start;\n        }\n\n        .smch-quick-stats {\n            grid-template-columns: 1fr;\n        }\n    }\n</style>",
        "storeOutMessages": false,
        "passthru": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 550,
        "y": 100,
        "wires": [
            []
        ]
    },
    {
        "id": "fetch_current_data",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Prepare Data Requests",
        "func": "const userSession = global.get('user_session');\n\nif (!userSession) {\n    // Nessuna sessione ‚Üí interrompi flusso\n    return [null, null, null];\n}\n\nconst deviceId = userSession.deviceId;\n\n// Messaggio per InfluxDB Adaptor (ultimo valore temperatura)\nconst msgInfluxTemp = {\n    payload: '',\n    url: `http://influxdb_adaptor:8002/sensors/temperature?device=${deviceId}&limit=1&duration=\"7d\"`,\n    method: 'GET',\n    topic: 'temperature_data'\n};\n\n// Messaggio per InfluxDB Adaptor (ultimo valore gas)\nconst msgInfluxGas = {\n    payload: '',\n    url: `http://influxdb_adaptor:8002/sensors/gas?device=${deviceId}&limit=1`,\n    method: 'GET',\n    topic: 'gas_data'\n};\n\n// Messaggio per InfluxDB Adaptor (ultimo valore umidit√†)\nconst msgInfluxHum = {\n    payload: '',\n    url: `http://influxdb_adaptor:8002/sensors/humidity?device=${deviceId}&limit=1`,\n    method: 'GET',\n    topic: 'humidity_data'\n};\n\n// Ritorno su tre uscite: \n// - [0] ‚Üí Temperatura\n// - [1] ‚Üí Gas\n// - [2] ‚Üí Umidit√†\nreturn [msgInfluxTemp, msgInfluxGas, msgInfluxHum];\n",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 200,
        "wires": [
            [
                "http_requests"
            ],
            [
                "http_requests"
            ],
            [
                "http_requests"
            ]
        ],
        "outputLabels": [
            "InfluxDB Temp",
            "InfluxDB Gas",
            "InfluxDB Hum"
        ]
    },
    {
        "id": "http_requests",
        "type": "http request",
        "z": "dashboard_tab",
        "name": "Fetch Real Data",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 560,
        "y": 200,
        "wires": [
            [
                "process_real_data",
                "833e4f2e733f995c"
            ]
        ]
    },
    {
        "id": "process_real_data",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Process Real Data",
        "func": "const userSession = global.get('user_session');\nconst topic = msg.topic;\n\nif (topic === 'temperature_data') {\n    const tempData = msg.payload?.e || [];\n    let currentTemp = '--';\n\n    if (tempData.length > 0) {\n        const latest = tempData[tempData.length - 1];\n        currentTemp = latest.v !== undefined ? Number(latest.v).toFixed(1) : '--';\n    }\n    flow.set('current_temperature', currentTemp);\n\n} else if (topic === 'gas_data') {\n    const gasData = msg.payload?.e || [];\n    let currentGas = '--';\n\n    if (gasData.length > 0) {\n        const latest = gasData[gasData.length - 1];\n        currentGas = latest.v !== undefined ? Number(latest.v).toFixed(1) : '--';\n    }\n    flow.set('current_gas', currentGas);\n\n} else if (topic === 'humidity_data') {\n    const humData = msg.payload?.e || [];\n    let currentHum = '--';\n\n    if (humData.length > 0) {\n        const latest = humData[humData.length - 1];\n        currentHum = latest.v !== undefined ? Number(latest.v).toFixed(1) : '--';\n    }\n    flow.set('current_humidity', currentHum);\n}\n\n// Ricostruisci lo stato attuale della dashboard\nmsg.payload = {\n    userName: userSession.userName,\n    deviceId: userSession.deviceId,\n    deviceName: `${userSession.userName}'s Fridge`,\n    lastSync: new Date().toLocaleString('it-IT'),\n    status: 'online',\n    temperature: flow.get('current_temperature') || '--',\n    gas: flow.get('current_gas') || '--',\n    humidity: flow.get('current_humidity') || '--'\n};\n\nmsg.topic = 'hero_update';\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 810,
        "y": 200,
        "wires": [
            [
                "hero_template"
            ]
        ]
    },
    {
        "id": "refresh_timer",
        "type": "inject",
        "z": "dashboard_tab",
        "name": "Auto Refresh",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "240",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "refresh",
        "payloadType": "str",
        "x": 160,
        "y": 300,
        "wires": [
            [
                "check_auth_refresh"
            ]
        ]
    },
    {
        "id": "check_auth_refresh",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Check Auth for Refresh",
        "func": "const userSession = global.get('user_session');\n\nif (userSession && userSession.isAuthenticated) {\n    msg.payload = {\n        command: 'refresh_data',\n        user: userSession\n    };\n    msg.topic = 'refresh';\n    return msg;\n}\n\nreturn null;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 300,
        "wires": [
            [
                "update_hero_data",
                "67863dc1b3cd63e5",
                "aab43d097f269a33",
                "87c3519ce88d036e"
            ]
        ]
    },
    {
        "id": "833e4f2e733f995c",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 6",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 260,
        "wires": []
    },
    {
        "id": "ff7622f60831a8fd",
        "type": "ui-template",
        "z": "dashboard_tab",
        "group": "hero_group",
        "page": "",
        "ui": "",
        "name": "Optimizer Panel",
        "order": 5,
        "width": "6",
        "height": "18",
        "head": "",
        "format": "<link href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" rel=\"stylesheet\">\n\n<template>\n  <div class=\"smch-opti-panel\">\n\n    <div class=\"smch-opti-panel-header\">\n      <h3 class=\"smch-opti-panel-title\">\n        <i class=\"material-icons\">auto_fix_high</i>\n        Efficiency Optimization\n      </h3>\n      <div class=\"smch-opti-status-badge\" :class=\"statusClass\">\n        <i class=\"material-icons smch-opti-status-icon\">{{ statusIcon }}</i>\n        {{ statusText }}\n      </div>\n    </div>\n\n    <div v-if=\"isLoading\" class=\"smch-opti-state-overlay smch-opti-loading-state\">\n      <div class=\"smch-opti-spinner\"></div>\n      <p>Analysis in progress...</p>\n    </div>\n    <div v-else-if=\"hasError\" class=\"smch-opti-state-overlay smch-opti-error-state\">\n      <i class=\"material-icons smch-opti-error-icon\">error_outline</i>\n      <h4>Service Unavailable</h4>\n      <p>{{ errorMessage }}</p>\n      <button @click=\"requestRefresh\" class=\"smch-opti-eco-button smch-opti-retry-btn\">\n            <i class=\"material-icons\">refresh</i>\n            Retry\n        </button>\n    </div>\n\n    <div v-else-if=\"hasData\" class=\"smch-opti-panel-content\">\n\n      <div class=\"smch-opti-section smch-opti-hero-metric\">\n        <div class=\"smch-opti-hero-label\">Estimated Consumption</div>\n        <div class=\"smch-opti-hero-value\">\n          {{ formatNumber(consumo.daily_kwh, 2) }}\n          <span class=\"smch-opti-hero-unit\">kWh / day</span>\n        </div>\n        <div class=\"smch-opti-hero-subtext\">\n          Based on a total runtime of <strong>{{ formatNumber(consumo.runtime_hours_per_day, 1) }} hours</strong>\n        </div>\n      </div>\n\n      <div class=\"smch-opti-section\">\n        <h4 class=\"smch-opti-section-title\">‚öñÔ∏è Consumption Breakdown</h4>\n        <div class=\"smch-opti-breakdown-list\">\n          <div class=\"smch-opti-breakdown-item\">\n            <span class=\"smch-opti-breakdown-label\">Base Runtime (Fridge Efficiency)</span>\n            <span class=\"smch-opti-breakdown-value\">{{ formatNumber(consumo.base_runtime_hours, 1) }} hrs</span>\n          </div>\n          <div class=\"smch-opti-breakdown-item\" v-if=\"consumo.door_penalty_hours > 0\">\n            <span class=\"smch-opti-breakdown-label\">Penalty (Door Openings)</span>\n            <span class=\"smch-opti-breakdown-value\">+ {{ formatNumber(consumo.door_penalty_hours, 1) }} hrs</span>\n          </div>\n          <div class=\"smch-opti-breakdown-item\" v-if=\"consumo.temperature_factor > 1.0\">\n            <span class=\"smch-opti-breakdown-label\">Temp. Stability Factor</span>\n            <span class=\"smch-opti-breakdown-value\">x {{ formatNumber(consumo.temperature_factor, 2) }}</span>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"smch-opti-section\">\n        <h4 class=\"smch-opti-section-title\">ü©∫ Key Indicators</h4>\n        <div class=\"smch-opti-indicators-grid\">\n          <div class=\"smch-opti-indicator-card smch-opti-gauge-card\">\n            <div class=\"smch-opti-indicator-label\">Compressor Duty Cycle</div>\n            <div class=\"smch-opti-gauge-container\">\n              <div class=\"smch-opti-gauge-bg\"></div>\n              <div class=\"smch-opti-gauge-fill\" :style=\"dutyCycleGauge.style\"></div>\n              <div class=\"smch-opti-gauge-center\"></div>\n              <div class=\"smch-opti-gauge-value\">{{ formatPercentage(cicli.duty_cycle_rilevato, 0) }}</div>\n            </div>\n            <div class=\"smch-opti-gauge-label\" :style=\"{ color: dutyCycleGauge.color }\">\n              {{ dutyCycleGauge.label }}\n            </div>\n            <div v-if=\"cicli.cicli_contati < 4\" class=\"smch-opti-low-cycle-warning\">\n              <i class=\"material-icons\">warning_amber</i>\n              Low accuracy ({{ cicli.cicli_contati }} cycles)\n            </div>\n          </div>\n          <div class=\"smch-opti-indicator-card smch-opti-stats-card\">\n            <div class=\"smch-opti-indicator-label\">Compressor Cycles</div>\n            <div class=\"smch-opti-stat-row\">\n              <i class=\"material-icons\">sync</i>\n              <span>Cycles Detected</span>\n              <strong :class=\"{ 'smch-opti-warn-text': cicli.cicli_contati < 4 }\">\n                            {{ cicli.cicli_contati }}\n                        </strong>\n            </div>\n            <div class=\"smch-opti-stat-row\">\n              <i class=\"material-icons\" style=\"color: var(--smch-opti-accent-green);\">play_arrow</i>\n              <span>Avg. ON Duration</span>\n              <strong>{{ formatNumber(cicli.durata_on_media, 0) }} min</strong>\n            </div>\n            <div class=\"smch-opti-stat-row\">\n              <i class=\"material-icons\" style=\"color: var(--smch-opti-accent-red);\">stop</i>\n              <span>Avg. OFF Duration</span>\n              <strong>{{ formatNumber(cicli.durata_off_media, 0) }} min</strong>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"smch-opti-section\" v-if=\"raccomandazioni.length > 0\">\n        <h4 class=\"smch-opti-section-title\">üí° Recommendations ({{ raccomandazioni.length }})</h4>\n        <div class=\"smch-opti-recommendations-list\">\n          <div v-for=\"(rec, index) in raccomandazioni\" :key=\"index\" class=\"smch-opti-rec-item\"\n            :class=\"'priority-' + rec.priorita\">\n            <div class=\"smch-opti-rec-icon\">{{ rec.icona }}</div>\n            <div class=\"smch-opti-rec-content\">\n              <div class=\"smch-opti-rec-message\">{{ rec.messaggio }}</div>\n              <div class=\"smch-opti-rec-savings\" v-if=\"rec.risparmio_kwh > 0\">\n                Est. savings: <strong>-{{ formatNumber(rec.risparmio_kwh, 2) }} kWh/day</strong>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div class=\"smch-opti-section\" v-if=\"predizioni.length > 0\">\n        <h4 class=\"smch-opti-section-title\">üìà 7-Day Consumption Forecast</h4>\n        <div class=\"smch-opti-predictions-chart\">\n          <div v-for=\"p in predizioni\" :key=\"p.giorno\" class=\"smch-opti-pred-bar-wrapper\">\n            <div class=\"smch-opti-pred-bar-value\">{{ formatNumber(p.kwh, 1) }}</div>\n            <div class=\"smch-opti-pred-bar\" :style=\"{ height: getBarHeight(p.kwh) + '%' }\"></div>\n            <div class=\"smch-opti-pred-bar-label\">{{ p.data_formattata }}</div>\n          </div>\n        </div>\n      </div>\n\n    </div>\n\n    <div v-else class=\"smch-opti-state-overlay smch-opti-no-data-state\">\n      <i class=\"material-icons smch-opti-no-data-icon\">analytics</i>\n      <h4>No Data Available</h4>\n      <p>Waiting for data from the optimization service.</p>\n    </div>\n\n    <div class=\"smch-opti-panel-footer\">\n      <div class=\"smch-opti-last-update\">\n        Updated: {{ formatTimestamp(lastUpdate) }}\n      </div>\n      <button @click=\"requestRefresh\" class=\"smch-opti-eco-button smch-opti-refresh-btn\" :disabled=\"isLoading\">\n            <i class=\"material-icons\" :class=\"{ spinning: isLoading }\">refresh</i>\n        </button>\n    </div>\n  </div>\n</template>\n\n<style>\n  /* === Variabili CSS Uniche per Optimizer Panel === */\n  :root {\n    --smch-opti-panel-bg: #f0f9f4;\n    --smch-opti-bg-color: #ffffff;\n    --smch-opti-text-primary: #1a2e3b;\n    --smch-opti-text-secondary: #5a7184;\n    --smch-opti-border-color: #e6f4ea;\n    --smch-opti-status-online-bg: #e8f5e9;\n    --smch-opti-status-online-text: #388e3c;\n    --smch-opti-status-loading-bg: #fff8e1;\n    --smch-opti-status-loading-text: #f57f17;\n    --smch-opti-status-error-bg: #ffebee;\n    --smch-opti-status-error-text: #d32f2f;\n    /* Rimosso status-warning-bg/text perch√© non c'√® pi√π un badge separato */\n    --smch-opti-accent-green: #4CAF50;\n    --smch-opti-accent-yellow: #FFC107;\n    --smch-opti-accent-red: #F44336;\n    --smch-opti-accent-blue: #2196F3;\n    --smch-opti-shadow: 0 4px 12px rgba(90, 113, 132, 0.08);\n  }\n\n  /* === Classi CSS Uniche con prefisso 'smch-opti-' === */\n  .smch-opti-panel {\n    background: var(--smch-opti-panel-bg);\n    border: 1px solid var(--smch-opti-border-color);\n    border-radius: 12px;\n    padding: 20px;\n    color: var(--smch-opti-text-primary);\n    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;\n    box-shadow: var(--smch-opti-shadow);\n    position: relative;\n    min-height: 400px;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .smch-opti-panel-content {\n    flex: 1;\n  }\n\n  /* Header e Footer */\n  .smch-opti-panel-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding-bottom: 16px;\n    border-bottom: 1px solid var(--smch-opti-border-color);\n    margin-bottom: 24px;\n  }\n\n  .smch-opti-panel-title {\n    margin: 0;\n    font-size: 1.25em;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n  }\n\n  .smch-opti-status-badge {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    padding: 6px 12px;\n    border-radius: 20px;\n    font-size: 0.8em;\n    font-weight: 600;\n  }\n\n  .smch-opti-status-badge .smch-opti-status-icon {\n    font-size: 1.1em;\n  }\n\n  .smch-opti-status-badge.status-active {\n    background: var(--smch-opti-status-online-bg);\n    color: var(--smch-opti-status-online-text);\n  }\n\n  .smch-opti-status-badge.status-loading {\n    background: var(--smch-opti-status-loading-bg);\n    color: var(--smch-opti-status-loading-text);\n  }\n\n  .smch-opti-status-badge.status-error {\n    background: var(--smch-opti-status-error-bg);\n    color: var(--smch-opti-status-error-text);\n  }\n\n  /* Rimosso stile status-warning */\n\n  .smch-opti-panel-footer {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding-top: 16px;\n    border-top: 1px solid var(--smch-opti-border-color);\n    margin-top: 24px;\n    font-size: 0.8em;\n    color: var(--smch-opti-text-secondary);\n  }\n\n  .smch-opti-eco-button {\n    /* Bottone refresh */\n    background: transparent;\n    border: none;\n    color: var(--smch-opti-text-secondary);\n    cursor: pointer;\n    padding: 4px;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: background 0.2s, color 0.2s;\n  }\n\n  .smch-opti-eco-button i {\n    font-size: 20px;\n  }\n\n  .smch-opti-eco-button:hover:not(:disabled) {\n    background: var(--smch-opti-border-color);\n    color: var(--smch-opti-text-primary);\n  }\n\n  .smch-opti-eco-button:disabled {\n    cursor: not-allowed;\n    opacity: 0.5;\n  }\n\n  .spinning {\n    animation: spin 1s linear infinite;\n  }\n\n  @keyframes spin {\n    100% {\n      transform: rotate(360deg);\n    }\n  }\n\n  /* Stati Overlay */\n  .smch-opti-state-overlay {\n    position: absolute;\n    top: 69px;\n    left: 0;\n    right: 0;\n    bottom: 53px;\n    background: rgba(240, 249, 244, 0.9);\n    backdrop-filter: blur(4px);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    z-index: 10;\n    text-align: center;\n    padding: 20px;\n  }\n\n  .smch-opti-state-overlay h4 {\n    margin: 10px 0 5px 0;\n    font-size: 1.1em;\n  }\n\n  .smch-opti-state-overlay p {\n    margin: 0;\n    color: var(--smch-opti-text-secondary);\n  }\n\n  .smch-opti-error-icon,\n  .smch-opti-no-data-icon,\n  .smch-opti-warning-icon {\n    font-size: 48px;\n  }\n\n  .smch-opti-error-icon {\n    color: var(--smch-opti-accent-red);\n  }\n\n  .smch-opti-no-data-icon {\n    color: var(--smch-opti-text-secondary);\n  }\n\n  .smch-opti-warning-icon {\n    color: var(--smch-opti-accent-yellow);\n  }\n\n  .smch-opti-spinner {\n    width: 36px;\n    height: 36px;\n    border: 4px solid var(--smch-opti-border-color);\n    border-top: 4px solid var(--smch-opti-accent-blue);\n    border-radius: 50%;\n    animation: spin 1s linear infinite;\n    margin-bottom: 16px;\n  }\n\n  .smch-opti-retry-btn {\n    background: var(--smch-opti-status-error-bg);\n    color: var(--smch-opti-status-error-text);\n    border-radius: 8px;\n    padding: 8px 16px;\n    margin-top: 20px;\n    font-weight: 600;\n  }\n\n  .smch-opti-retry-btn:hover {\n    background: #ffcdd2;\n  }\n\n  /* Layout Sezioni */\n  .smch-opti-section {\n    margin-bottom: 28px;\n  }\n\n  .smch-opti-section-title {\n    margin: 0 0 16px 0;\n    font-size: 1.1em;\n    font-weight: 600;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    color: var(--smch-opti-text-primary);\n  }\n\n  /* Hero Metric */\n  .smch-opti-hero-metric {\n    text-align: center;\n    padding: 16px;\n    background: linear-gradient(135deg, #e8f5e9, #f1f8e9);\n    border-radius: 12px;\n    margin-bottom: 28px;\n  }\n\n  .smch-opti-hero-label {\n    font-size: 0.9em;\n    font-weight: 600;\n    color: var(--smch-opti-accent-green);\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n\n  .smch-opti-hero-value {\n    font-size: 3.2em;\n    font-weight: 700;\n    color: var(--smch-opti-text-primary);\n    line-height: 1.2;\n    margin: 4px 0;\n  }\n\n  .smch-opti-hero-unit {\n    font-size: 0.4em;\n    font-weight: 500;\n    color: var(--smch-opti-text-secondary);\n    margin-left: 4px;\n  }\n\n  .smch-opti-hero-subtext {\n    font-size: 0.9em;\n    color: var(--smch-opti-text-secondary);\n  }\n\n  /* Breakdown List */\n  .smch-opti-breakdown-list {\n    display: flex;\n    flex-direction: column;\n    gap: 10px;\n  }\n\n  .smch-opti-breakdown-item {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    padding: 12px;\n    background: var(--smch-opti-bg-color);\n    border: 1px solid var(--smch-opti-border-color);\n    border-radius: 8px;\n    font-size: 0.9em;\n  }\n\n  .smch-opti-breakdown-label {\n    color: var(--smch-opti-text-secondary);\n    font-weight: 500;\n  }\n\n  .smch-opti-breakdown-value {\n    font-weight: 600;\n    font-size: 1.1em;\n  }\n\n  /* Indicatori */\n  .smch-opti-indicators-grid {\n    display: grid;\n    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n    gap: 16px;\n  }\n\n  .smch-opti-indicator-card {\n    background: var(--smch-opti-bg-color);\n    border: 1px solid var(--smch-opti-border-color);\n    border-radius: 8px;\n    padding: 16px;\n  }\n\n  .smch-opti-indicator-label {\n    font-size: 0.9em;\n    font-weight: 600;\n    color: var(--smch-opti-text-secondary);\n    margin-bottom: 12px;\n    text-align: center;\n  }\n\n  .smch-opti-stats-card {\n    display: flex;\n    flex-direction: column;\n    justify-content: center;\n    gap: 12px;\n  }\n\n  .smch-opti-stat-row {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    gap: 8px;\n    font-size: 0.9em;\n  }\n\n  .smch-opti-stat-row i {\n    font-size: 18px;\n    color: var(--smch-opti-text-secondary);\n  }\n\n  .smch-opti-stat-row strong {\n    font-size: 1.1em;\n  }\n\n  /* *** NUOVO: Stile per avviso su pochi cicli *** */\n  .smch-opti-warn-text {\n    color: var(--smch-opti-accent-yellow);\n    font-weight: bold;\n  }\n\n  .smch-opti-low-cycle-warning {\n    font-size: 0.8em;\n    color: var(--smch-opti-accent-yellow);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 4px;\n    margin-top: 8px;\n    font-weight: 500;\n  }\n\n  .smch-opti-low-cycle-warning i {\n    font-size: 1.1em;\n  }\n\n  /* Gauge */\n  .smch-opti-gauge-card {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: space-between;\n    min-height: 170px;\n  }\n\n  .smch-opti-gauge-container {\n    width: 150px;\n    height: 75px;\n    position: relative;\n    overflow: hidden;\n    margin-bottom: 8px;\n  }\n\n  .smch-opti-gauge-bg,\n  .smch-opti-gauge-fill {\n    width: 100%;\n    height: 100%;\n    position: absolute;\n    border-top-left-radius: 150px;\n    border-top-right-radius: 150px;\n  }\n\n  .smch-opti-gauge-bg {\n    background: var(--smch-opti-border-color);\n  }\n\n  .smch-opti-gauge-fill {\n    background: linear-gradient(90deg, var(--smch-opti-accent-green), var(--smch-opti-accent-yellow), var(--smch-opti-accent-red));\n    transform-origin: 50% 100%;\n    transition: transform 0.5s ease;\n  }\n\n  .smch-opti-gauge-center {\n    width: 80%;\n    height: 80%;\n    background: var(--smch-opti-bg-color);\n    position: absolute;\n    bottom: 0;\n    left: 10%;\n    border-top-left-radius: 150px;\n    border-top-right-radius: 150px;\n  }\n\n  .smch-opti-gauge-value {\n    position: absolute;\n    bottom: 5px;\n    width: 100%;\n    text-align: center;\n    font-size: 1.8em;\n    font-weight: 700;\n    z-index: 1;\n  }\n\n  .smch-opti-gauge-label {\n    font-size: 0.9em;\n    font-weight: 600;\n    transition: color 0.5s ease;\n    text-align: center;\n    /* Aggiunto */\n  }\n\n  /* Raccomandazioni */\n  .smch-opti-recommendations-list {\n    display: flex;\n    flex-direction: column;\n    gap: 12px;\n  }\n\n  .smch-opti-rec-item {\n    display: flex;\n    align-items: flex-start;\n    gap: 12px;\n    background: var(--smch-opti-bg-color);\n    border: 1px solid var(--smch-opti-border-color);\n    padding: 16px;\n    border-radius: 8px;\n    border-left-width: 4px;\n  }\n\n  .smch-opti-rec-item.priority-high {\n    border-left-color: var(--smch-opti-accent-red);\n  }\n\n  .smch-opti-rec-item.priority-medium {\n    border-left-color: var(--smch-opti-accent-yellow);\n  }\n\n  .smch-opti-rec-item.priority-low {\n    border-left-color: var(--smch-opti-accent-green);\n  }\n\n  .smch-opti-rec-icon {\n    font-size: 1.8em;\n    margin-top: -2px;\n  }\n\n  .smch-opti-rec-content {\n    flex: 1;\n  }\n\n  .smch-opti-rec-message {\n    font-size: 0.9em;\n    font-weight: 500;\n    line-height: 1.4;\n  }\n\n  .smch-opti-rec-savings {\n    font-size: 0.8em;\n    color: var(--smch-opti-accent-green);\n    margin-top: 8px;\n  }\n\n  /* Predizioni */\n  /* Add this rule to hide the scrollbar */\n.smch-opti-predictions-chart {\n    display: flex; \n    align-items: flex-end; \n    gap: 10px; \n    height: 150px;\n    padding: 16px 16px 12px 16px; \n    background: var(--smch-opti-bg-color); \n    border: 1px solid var(--smch-opti-border-color); \n    border-radius: 8px; \n    width: 100%; \n    /* overflow-x: auto;  <-- Remove or comment out this line */\n    overflow-x: hidden; /* <-- Add this line */\n    box-sizing: border-box; /* Add for better width calculation */\n}\n\n.smch-opti-pred-bar-wrapper { \n    flex: 1 1 0; /* Allow bars to shrink slightly if needed */\n    display: flex; \n    flex-direction: column; \n    align-items: center; \n    height: 100%; \n    min-width: 35px; /* Slightly reduce min-width if needed */\n}\n\n/* Optional: Ensure bars don't force overflow */\n.smch-opti-pred-bar-wrapper { \n    flex: 1 1 0; /* Allow bars to shrink slightly if needed */\n    display: flex; \n    flex-direction: column; \n    align-items: center; \n    height: 100%; \n    min-width: 35px; /* Slightly reduce min-width if needed */\n}\n\n  .smch-opti-pred-bar-wrapper {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    height: 100%;\n    min-width: 40px;\n  }\n\n  .smch-opti-pred-bar-value {\n    font-size: 0.75em;\n    font-weight: 600;\n    color: var(--smch-opti-text-primary);\n    margin-bottom: 2px;\n  }\n\n  .smch-opti-pred-bar {\n    width: 100%;\n    flex: 1;\n    background: var(--smch-opti-accent-blue);\n    opacity: 0.7;\n    border-radius: 4px 4px 0 0;\n    transition: height 0.4s ease;\n    align-self: flex-end;\n  }\n\n  .smch-opti-pred-bar-label {\n    margin-top: 8px;\n    font-size: 0.75em;\n    color: var(--smch-opti-text-secondary);\n    font-weight: 600;\n    white-space: nowrap;\n  }\n</style>\n\n<script>\n  export default {\n    data() {\n        return {\n            isLoading: false,\n            hasError: false,\n            errorMessage: '',\n            lastUpdate: null,\n            // Data properties matching the <template> bindings\n            consumo: {\n                daily_kwh: '--',\n                runtime_hours_per_day: '--',\n                base_runtime_hours: '--',\n                door_penalty_hours: 0,\n                temperature_factor: 1\n            },\n            cicli: { \n                // *** CORRECTION: Use names expected by the template ***\n                duty_cycle_rilevato: null, // Was missing, will hold estimated_duty_cycle\n                cicli_contati: 0,          // Was cycle_count\n                durata_on_media: '--',     // Was avg_on_duration_minutes\n                durata_off_media: '--',    // Was avg_off_duration_minutes\n                confidenza: 0              // Still needed for gauge logic (implicitly)\n            },\n            raccomandazioni: [], // Renamed from recommendations for template\n            predizioni: [],      // Renamed from predictions for template\n            analisi: {} \n        }\n    },\n    computed: {\n        // hasData checks if essential data arrived and isn't just placeholder\n        hasData() {\n             return this.consumo && this.consumo.daily_kwh !== undefined && this.consumo.daily_kwh !== '--';\n        },\n        statusClass() {\n            if (this.isLoading) return 'status-loading';\n            if (this.hasError) return 'status-error';\n            return 'status-active';\n        },\n        statusText() {\n            if (this.isLoading) return 'Analyzing...';\n            if (this.hasError) return 'Error';\n            return 'Active';\n        },\n        statusIcon() {\n            if (this.isLoading) return 'hourglass_top';\n            if (this.hasError) return 'error';\n            return 'check_circle';\n        },\n        dutyCycleGauge() {\n            // Now reads from the correctly named property\n            const value = this.cicli.duty_cycle_rilevato || 0; \n            const max = 0.6; \n            const percentage = Math.min(1, value / max);\n            \n            let color = 'var(--smch-opti-accent-green)';\n            let label = 'Optimal Efficiency';\n            if (percentage > 0.8) {\n                color = 'var(--smch-opti-accent-red)';\n                label = 'High (Check)';\n            } else if (percentage > 0.6) {\n                color = 'var(--smch-opti-accent-yellow)';\n                label = 'Moderate';\n            }\n            // Add warning based on cycle count (using correct name)\n            if (this.cicli.cicli_contati !== undefined && this.cicli.cicli_contati < 4) {\n                 label += ' (Low Data)';\n                 color = 'var(--smch-opti-accent-yellow)'; \n            }\n            \n            return {\n                style: { transform: `rotate(${(percentage * 180)}deg)` },\n                color: color, label: label\n            };\n        },\n        maxPredictionKwh() {\n            if (!this.predizioni || this.predizioni.length === 0) return 1;\n             // Use correct property name from function node mapping\n            const kwhValues = this.predizioni.map(p => p.predicted_kwh || p.kwh || 0);\n            return Math.max(...kwhValues, 1);\n        }\n    },\n    methods: {\n        // methods remain the same\n        formatNumber(value, decimals = 1) {\n            if (value === null || value === undefined || value === '--') return '--';\n            // Ensure value is treated as number before toFixed\n            const num = Number(value);\n            return isNaN(num) ? '--' : num.toFixed(decimals);\n        },\n        formatPercentage(value, decimals = 0) {\n            if (value === null || value === undefined || (typeof value === 'string' && value.includes('--'))) return '--%';\n            const numericValue = Number(value);\n            if (isNaN(numericValue)) return '--%';\n            return (numericValue * 100).toFixed(decimals) + '%';\n        },\n        formatTimestamp(isoString) {\n            if (!isoString) return 'Never';\n            try {\n                return new Date(isoString).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });\n            } catch (e) { return 'Just now'; }\n        },\n        getBarHeight(value) {\n            const numericValue = Number(value || 0);\n            const maxKwh = this.maxPredictionKwh || 1; \n            const height = 10 + (numericValue / maxKwh) * 90;\n            return Math.max(0, Math.min(100, height || 10)); \n        },\n        // *** CORRECTION: Use property name from function node mapping ***\n        formatPredictionDate(dateStr) { \n             // This used 'formatted_date' which doesn't exist in the function node output for predictions\n             // The function node formats it directly in the 'date' or 'formatted_date' property it adds\n             // Let's rely on the formatted date coming from the function node if possible\n             return dateStr || 'N/A'; // Directly use the formatted string if available\n        },\n        // *** CORRECTION: Ensure icon helper uses correct property name ***\n         getRecommendationIcon(type) { // Added this helper locally\n            const iconMap = {\n                'behavioral': 'üë§',\n                'maintenance': 'üîß',\n                'alert': '‚ö†Ô∏è', // Correct icon from data\n                'energy': '‚ö°',\n                'setting': '‚öôÔ∏è',\n                'efficiency': 'üìä'\n            };\n            return iconMap[type] || 'üí°';\n        },\n        requestRefresh() {\n            this.send({ topic: 'request_optimizer_refresh', payload: true });\n        }\n    },\n    watch: {\n        msg: {\n            handler(newMsg) {\n                if (!newMsg) return;\n\n                if (newMsg.loading === true) { this.isLoading = true; this.hasError = false; return; } \n                if (newMsg.error) { this.isLoading = false; this.hasError = true; this.errorMessage = typeof newMsg.error === 'string' ? newMsg.error : \"Unknown processing error\"; return; }\n                \n                // Process the main payload prepared by the function node\n                // Check for the specific structure created by the function node\n                if (newMsg.payload && typeof newMsg.payload === 'object' && newMsg.payload.current_energy) {\n                    this.isLoading = false; \n                    const data = newMsg.payload; \n\n                    if (data.error) { this.hasError = true; this.errorMessage = data.error; return; }\n\n                    this.hasError = false;\n                    this.lastUpdate = newMsg.timestamp || data.timestamp || new Date().toISOString(); \n\n                    // *** CORRECT & COMPLETE MAPPING ***\n                    \n                    // 1. Map 'consumo' data\n                    if (data.current_energy) {\n                        this.consumo = {\n                            daily_kwh: data.current_energy.daily_kwh ?? '--',\n                            runtime_hours_per_day: data.current_energy.runtime_hours_per_day ?? '--',\n                            base_runtime_hours: data.current_energy.base_runtime_hours ?? '--',\n                            door_penalty_hours: data.current_energy.door_penalty_hours ?? 0,\n                            temperature_factor: data.current_energy.temperature_factor ?? 1\n                        };\n                    } else {\n                        this.consumo = {}; // Reset if missing\n                    }\n\n                    // 2. Map 'cicli' data from nested 'cycle_analysis'\n                    if (data.current_energy && data.current_energy.cycle_analysis) {\n                         const cycleData = data.current_energy.cycle_analysis;\n                         this.cicli = {\n                             // Map source names to template names\n                             duty_cycle_rilevato: cycleData.estimated_duty_cycle ?? null,\n                             cicli_contati: cycleData.cycle_count ?? 0,\n                             durata_on_media: cycleData.avg_on_duration_minutes ?? '--',\n                             durata_off_media: cycleData.avg_off_duration_minutes ?? '--',\n                             confidenza: cycleData.confidence ?? 0 // Keep confidence if needed elsewhere\n                         };\n                    } else {\n                         // Fallback if cycle_analysis is missing\n                         this.cicli = { duty_cycle_rilevato: data.current_energy?.base_duty_cycle ?? null, cicli_contati: 0, durata_on_media: '--', durata_off_media: '--', confidenza: 0 };\n                    }\n\n                    // 3. Map 'raccomandazioni' (rename from recommendations)\n                    // The function node already maps this correctly with icons\n                    this.raccomandazioni = (data.recommendations || []).map(r => ({\n                        ...r, // Copy all properties\n                        icona: r.icon || this.getRecommendationIcon(r.type), // Ensure icon exists\n                        priorita: r.priority || 'medium', // Ensure priority exists\n                        messaggio: r.message || 'No details', // Ensure message exists\n                        risparmio_kwh: r.potential_savings_kwh || 0 // Ensure savings exist\n                    })); \n\n                    // 4. Map 'predizioni' (rename from predictions)\n                    // The function node already maps this correctly with formatted date\n                     this.predizioni = (data.predictions || []).map(p => ({\n                        ...p, // Copy all properties\n                        // Ensure required fields for template exist\n                        kwh: p.predicted_kwh || 0, \n                        runtime_ore: p.predicted_runtime_hours || 0,\n                        data_formattata: p.formatted_date || this.formatPredictionDate(p.date) // Use formatted if available\n                     }));\n\n                    // 5. Map 'analisi' (rename from analysis_info)\n                    this.analisi = data.analysis_info || {};        \n\n                } else if (!this.isLoading) { \n                    if (this.lastUpdate) { \n                       this.hasError = true;\n                       this.errorMessage = \"Received unexpected data format.\";\n                    }\n                }\n            },\n            immediate: true,\n            deep: true \n        }\n    }\n}\n</script>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 440,
        "wires": [
            []
        ]
    },
    {
        "id": "67863dc1b3cd63e5",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Update Optimizer Panel",
        "func": "const userSession = global.get('user_session');\n\nif (!userSession || !userSession.isAuthenticated) {\n    return null;\n}\n\nconst response = msg.payload || {};\n\n// Prepara payload standardizzato per la UI (NUOVA STRUTTURA)\nmsg.payload = {\n    timestamp: new Date().toISOString(),\n\n    // Sezione consumo basata su duty cycle\n    consumo: {\n        daily_kwh: response.current_energy?.daily_kwh ?? '--',\n        runtime_hours_per_day: response.current_energy?.runtime_hours_per_day ?? '--',\n        base_duty_cycle: response.current_energy?.base_duty_cycle ?? null,\n        base_runtime_hours: response.current_energy?.base_runtime_hours ?? '--',\n        door_penalty_hours: response.current_energy?.door_penalty_hours ?? 0,\n        temperature_factor: response.current_energy?.temperature_factor ?? 1,\n        compressor_power_watts: response.current_energy?.compressor_power_watts ?? '--'\n    },\n\n    // Analisi cicli compressore\n    cicli: {\n        duty_cycle_rilevato: response.current_energy?.cycle_analysis?.estimated_duty_cycle ?? null,\n        cicli_contati: response.current_energy?.cycle_analysis?.cycle_count ?? 0,\n        durata_on_media: response.current_energy?.cycle_analysis?.avg_on_duration_minutes ?? '--',\n        durata_off_media: response.current_energy?.cycle_analysis?.avg_off_duration_minutes ?? '--',\n        confidenza: response.current_energy?.cycle_analysis?.confidence ?? 0\n    },\n\n    // Raccomandazioni (aggiornate con runtime)\n    raccomandazioni: (response.recommendations || []).map(r => ({\n        icona: r.icon || getRecommendationIcon(r.type),\n        tipo: r.type || 'generic',\n        priorita: r.priority || 'medium',\n        messaggio: r.message || '---',\n        risparmio_kwh: r.potential_savings_kwh ?? 0,\n        risparmio_percent: r.potential_savings_percent ?? 0,\n        risparmio_runtime_ore: r.runtime_savings_hours ?? 0\n    })),\n\n    // Predizioni (aggiornate con runtime)\n    predizioni: (response.predictions || []).map(p => ({\n        giorno: p.day,\n        data_formattata: formatDate(p.date),\n        kwh: p.predicted_kwh,\n        runtime_ore: p.predicted_runtime_hours,\n        timestamp: p.timestamp\n    })),\n\n    // Metadati analisi\n    analisi: {\n        metodo: response.analysis_info?.analysis_method || 'duty_cycle_based',\n        modello: response.analysis_info?.model || 'unknown',\n        cached: response.analysis_info?.cached || false,\n        servizio: response.analysis_info?.service || 'energy_optimization'\n    },\n\n    error: response.error || null,\n    message: response.message || null\n};\n\nmsg.topic = 'optimizer_update';\n\n// Helper function locale\nfunction getRecommendationIcon(type) {\n    const iconMap = {\n        'behavioral': 'üë§',\n        'maintenance': 'üîß',\n        'alert': '‚ö†Ô∏è',\n        'energy': '‚ö°'\n    };\n    return iconMap[type] || 'üí°';\n}\n\nfunction formatDate(dateStr) {\n    if (!dateStr) return 'N/A';\n    try {\n        return new Date(dateStr).toLocaleDateString('it-IT', {\n            day: '2-digit',\n            month: '2-digit'\n        });\n    } catch (e) {\n        return dateStr.substring(5, 10);\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 330,
        "y": 440,
        "wires": [
            [
                "ff7622f60831a8fd",
                "562af8c5211c75bb"
            ]
        ]
    },
    {
        "id": "562af8c5211c75bb",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Prepare Data Requests",
        "func": "const userSession = global.get('user_session');\nif (!userSession || !userSession.deviceId) {\n    node.warn(\"No valid user session or device ID\");\n    return null;\n}\n\nconst deviceId = userSession.deviceId;\n\n// Messaggio per Energy Optimization Service - endpoint optimize\nconst msgOptimize = {\n    payload: '',\n    url: `http://energy_optimization:8003/optimize/${deviceId}`,\n    method: 'GET',\n    headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json'\n    },\n    topic: 'energy_optimize',\n    device_id: deviceId,\n    request_type: 'duty_cycle_optimization',\n    timestamp: new Date().toISOString()\n};\n\n// Log per debugging\nnode.log(`Requesting duty cycle energy optimization for device: ${deviceId}`);\nnode.log(`URL: ${msgOptimize.url}`);\n\nreturn msgOptimize;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 520,
        "wires": [
            [
                "20a8ff4fee74438a"
            ]
        ],
        "outputLabels": [
            "data_analysis_full"
        ]
    },
    {
        "id": "20a8ff4fee74438a",
        "type": "http request",
        "z": "dashboard_tab",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 630,
        "y": 520,
        "wires": [
            [
                "834cacf238c0fe4d",
                "875a7e4aa8d9aab9"
            ]
        ]
    },
    {
        "id": "834cacf238c0fe4d",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Process Data",
        "func": "// Function per processare la risposta del servizio Energy Optimization\n\n// Prima invia stato di loading alla UI\nconst loadingMsg = {\n    payload: null,\n    loading: true,\n    error: false\n};\n\n// Controlla se la richiesta HTTP √® andata a buon fine\nif (msg.statusCode && msg.statusCode !== 200) {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: `Servizio non disponibile (HTTP ${msg.statusCode})`,\n        statusCode: msg.statusCode\n    };\n\n    node.error(`HTTP Error ${msg.statusCode} from Energy Optimization Service`);\n    return errorMsg;\n}\n\n// Controlla se abbiamo ricevuto dati validi\nconst rawData = msg.payload;\nif (!rawData || typeof rawData !== 'object') {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: \"Dati non validi ricevuti dal servizio\"\n    };\n\n    node.error(\"Invalid data received from Energy Optimization Service\");\n    return errorMsg;\n}\n\n// Controlla se c'√® un errore nel payload\nif (rawData.error) {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: rawData.error || \"Errore sconosciuto dal servizio\"\n    };\n\n    node.error(`Service error: ${rawData.error}`);\n    return errorMsg;\n}\n\n// Processa i dati per la UI Template (NUOVA STRUTTURA DUTY CYCLE)\ntry {\n    const processedData = {\n        loading: false,\n        error: false,\n        timestamp: new Date().toISOString(),\n        device_id: rawData.device_id || msg.device_id,\n\n        payload: {\n            // Sezione energia basata su duty cycle\n            current_energy: {\n                daily_kwh: rawData.current_energy?.daily_kwh || 0,\n                runtime_hours_per_day: rawData.current_energy?.runtime_hours_per_day || 0,\n                base_duty_cycle: rawData.current_energy?.base_duty_cycle || 0,\n                base_runtime_hours: rawData.current_energy?.base_runtime_hours || 0,\n                door_penalty_hours: rawData.current_energy?.door_penalty_hours || 0,\n                temperature_factor: rawData.current_energy?.temperature_factor || 1,\n                compressor_power_watts: rawData.current_energy?.compressor_power_watts || 120,\n                // Analisi cicli del compressore\n                cycle_analysis: {\n                    estimated_duty_cycle: rawData.current_energy?.cycle_analysis?.estimated_duty_cycle || 0,\n                    cycle_count: rawData.current_energy?.cycle_analysis?.cycle_count || 0,\n                    avg_on_duration_minutes: rawData.current_energy?.cycle_analysis?.avg_on_duration_minutes || 0,\n                    avg_off_duration_minutes: rawData.current_energy?.cycle_analysis?.avg_off_duration_minutes || 0,\n                    confidence: rawData.current_energy?.cycle_analysis?.confidence || 0\n                }\n            },\n\n            // Sezione raccomandazioni (aggiornata per includere runtime)\n            recommendations: (rawData.recommendations || []).map(rec => ({\n                type: rec.type || 'generic',\n                priority: rec.priority || 'medium',\n                message: rec.message || 'Nessun messaggio disponibile',\n                potential_savings_kwh: Number(rec.potential_savings_kwh || 0),\n                potential_savings_percent: Number(rec.potential_savings_percent || 0),\n                runtime_savings_hours: Number(rec.runtime_savings_hours || 0),\n                icon: getRecommendationIcon(rec.type)\n            })),\n\n            // Sezione predizioni (aggiornata per runtime)\n            predictions: (rawData.predictions || []).slice(0, 7).map(pred => ({\n                day: pred.day || 0,\n                date: pred.date || '',\n                predicted_kwh: Number(pred.predicted_kwh || 0),\n                predicted_runtime_hours: Number(pred.predicted_runtime_hours || 0),\n                timestamp: pred.timestamp || null,\n                formatted_date: formatPredictionDate(pred.date)\n            })),\n\n            // Metadati aggiornati\n            analysis_info: {\n                cached: rawData.cached || false,\n                model: rawData.model || 'unknown',\n                analysis_method: rawData.analysis_method || 'duty_cycle_based',\n                analysis_timestamp: rawData.analysis_timestamp,\n                service: rawData.service || 'energy_optimization'\n            }\n        }\n    };\n\n    // Log per debugging\n    node.log(`Processed duty cycle energy data for ${processedData.device_id}:`);\n    node.log(`- Daily consumption: ${processedData.payload.current_energy.daily_kwh} kWh`);\n    node.log(`- Runtime hours/day: ${processedData.payload.current_energy.runtime_hours_per_day}h`);\n    node.log(`- Duty cycle: ${(processedData.payload.current_energy.base_duty_cycle * 100).toFixed(1)}%`);\n    node.log(`- Cycle confidence: ${(processedData.payload.current_energy.cycle_analysis.confidence * 100).toFixed(1)}%`);\n    node.log(`- Recommendations: ${processedData.payload.recommendations.length}`);\n    node.log(`- Predictions: ${processedData.payload.predictions.length}`);\n\n    // Salva timestamp per tracking\n    global.set('last_energy_update', processedData.timestamp);\n\n    return processedData;\n\n} catch (error) {\n    // Gestione errori durante il processing\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: `Errore elaborazione dati: ${error.message}`\n    };\n\n    node.error(`Error processing energy data: ${error.message}`, msg);\n    return errorMsg;\n}\n\n// Helper functions (aggiornate)\nfunction getRecommendationIcon(type) {\n    const iconMap = {\n        'behavioral': 'üë§',\n        'maintenance': 'üîß',\n        'alert': '‚ö†Ô∏è',\n        'energy': '‚ö°',\n        'setting': '‚öôÔ∏è',\n        'efficiency': 'üìä'\n    };\n    return iconMap[type] || 'üí°';\n}\n\nfunction formatPredictionDate(dateStr) {\n    if (!dateStr) return 'N/A';\n\n    try {\n        const date = new Date(dateStr);\n        return date.toLocaleDateString('it-IT', {\n            weekday: 'short',\n            day: '2-digit'\n        });\n    } catch (e) {\n        return dateStr.substring(5, 10); // MM-DD fallback\n    }\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 520,
        "wires": [
            [
                "ff7622f60831a8fd",
                "c9cabd05d3aa442c"
            ]
        ]
    },
    {
        "id": "875a7e4aa8d9aab9",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 7",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 840,
        "y": 580,
        "wires": []
    },
    {
        "id": "b6d994977ac1a479",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 8",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 900,
        "y": 820,
        "wires": []
    },
    {
        "id": "aab43d097f269a33",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Update Analysis Panel",
        "func": "const userSession = global.get('user_session');\n\nif (!userSession || !userSession.isAuthenticated) {\n    return null;\n}\n\nconst response = msg.payload || {};\n\n// Prepara payload per UI Template\nmsg.payload = {\n    timestamp: new Date().toISOString(),\n\n    // Analisi temperatura\n    temperature_analysis: {\n        avg_temperature: response.temperature_analysis?.avg_temperature ?? 0,\n        min_temperature: response.temperature_analysis?.min_temperature ?? 0,\n        max_temperature: response.temperature_analysis?.max_temperature ?? 0,\n        stability_score: response.temperature_analysis?.stability_score ?? 0,\n        out_of_range_time_percent: response.temperature_analysis?.out_of_range_time_percent ?? 0\n    },\n\n    // Analisi utilizzo\n    usage_analysis: {\n        avg_daily_openings: response.usage_analysis?.avg_daily_openings ?? 0,\n        avg_duration_seconds: response.usage_analysis?.avg_duration_seconds ?? 0,\n        efficiency_score: response.usage_analysis?.efficiency_score ?? 0\n    },\n\n    // Tendenze\n    trends: {\n        temperature_trend: response.trends?.temperature_trend ?? 'stable',\n        usage_trend: response.trends?.usage_trend ?? 'stable'\n    },\n\n    // Riassunto dati\n    data_summary: {\n        temperature_points: response.data_summary?.temperature_points ?? 0,\n        door_events: response.data_summary?.door_events ?? 0,\n        period_days: response.data_summary?.period_days ?? 0\n    },\n\n    error: response.error || null\n};\n\nmsg.topic = 'analysis_update';\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 680,
        "wires": [
            [
                "f358f0ed0611f2cf",
                "85c8cd9e15241e42"
            ]
        ]
    },
    {
        "id": "f358f0ed0611f2cf",
        "type": "ui-template",
        "z": "dashboard_tab",
        "group": "hero_group",
        "page": "",
        "ui": "",
        "name": "Analysis Panel",
        "order": 6,
        "width": "6",
        "height": "12",
        "head": "",
        "format": "<link href=\"https://fonts.googleapis.com/icon?family=Material+Icons\" rel=\"stylesheet\">\n\n<template>\n<div class=\"smch-health-panel\">\n    \n    <div class=\"smch-health-panel-header\">\n        <h3 class=\"smch-health-panel-title\">\n            <i class=\"material-icons\">insights</i>\n            Health & Usage Report\n        </h3>\n        <div class=\"smch-health-status-badge\" :class=\"statusClass\">\n            <i class=\"material-icons smch-health-status-icon\">{{ statusIcon }}</i>\n            {{ statusText }}\n        </div>\n    </div>\n\n    <div v-if=\"isLoading\" class=\"smch-health-state-overlay smch-health-loading-state\">\n        <div class=\"smch-health-spinner\"></div>\n        <p>Analyzing data...</p>\n    </div>\n    <div v-else-if=\"hasError\" class=\"smch-health-state-overlay smch-health-error-state\">\n        <i class=\"material-icons smch-health-error-icon\">error_outline</i>\n        <h4>Data Analysis Unavailable</h4>\n        <p>{{ errorMessage }}</p>\n        <button @click=\"requestRefresh\" class=\"smch-health-eco-button smch-health-retry-btn\">\n            <i class=\"material-icons\">refresh</i>\n            Retry\n        </button>\n    </div>\n\n    <div v-else-if=\"isUnreliable\" class=\"smch-health-state-overlay smch-health-warning-state\">\n        <i class=\"material-icons smch-health-warning-icon\">query_stats</i>\n        <h4>Insufficient Data for Analysis</h4>\n        <p>\n            Too few data points were collected recently.\n            Current estimates are based on fallback values and are not accurate.\n        </p>\n        <p style=\"margin-top: 10px; font-weight: 500;\">\n            Please wait for more data for an accurate analysis.\n        </p>\n    </div>\n\n\n    <div v-else-if=\"hasData\" class=\"smch-health-panel-content\">\n        \n        <div class=\"smch-health-period-info\">\n            Analysis based on data from the <strong>last {{ analysisInfo.period }}</strong>\n        </div>\n\n        <div class=\"smch-health-section\">\n            <h4 class=\"smch-health-section-title\"><i class=\"material-icons\">thermostat</i> Thermal Performance</h4>\n            <div class=\"smch-health-indicators-grid\">\n                <div class=\"smch-health-indicator-card smch-health-gauge-card\">\n                    <div class=\"smch-health-indicator-label\">Temperature Stability</div>\n                    <div class=\"smch-health-gauge-container\">\n                        <div class=\"smch-health-gauge-bg\"></div>\n                        <div class=\"smch-health-gauge-fill\" :style=\"stabilityGauge.style\"></div>\n                        <div class=\"smch-health-gauge-center\"></div>\n                        <div class=\"smch-health-gauge-value\">{{ formatPercentage(temperature.stability_score / 100, 0) }}</div>\n                    </div>\n                    <div class=\"smch-health-gauge-label\" :style=\"{ color: stabilityGauge.color }\">\n                        {{ stabilityGauge.label }}\n                    </div>\n                </div>\n                <div class=\"smch-health-indicator-card smch-health-stats-card\">\n                    <div class=\"smch-health-stat-row\">\n                        <i class=\"material-icons smch-health-icon-secondary\">analytics</i>\n                        <span>Average Temp.</span>\n                        <strong>{{ formatTemp(temperature.avg_temperature) }}</strong>\n                    </div>\n                    <div class=\"smch-health-stat-row\">\n                        <i class=\"material-icons smch-health-icon-secondary\">warning_amber</i>\n                        <span>Out of Range Time</span>\n                        <strong :class=\"{ 'smch-health-warn-text': temperature.out_of_range_time_percent > 10 }\">\n                            {{ formatPercentage(temperature.out_of_range_time_percent / 100, 0) }}\n                        </strong>\n                    </div>\n                    <div class=\"smch-health-stat-row\">\n                        <i class=\"material-icons smch-health-icon-secondary\">trending_up</i>\n                        <span>Temperature Trend</span>\n                        <strong :class=\"'smch-health-trend-' + trends.temperature_trend\">\n                            <i class=\"material-icons smch-health-trend-icon\">{{ getTrendIcon(trends.temperature_trend) }}</i>\n                            {{ getTrendText(trends.temperature_trend) }}\n                        </strong>\n                    </div>\n                </div>\n            </div>\n        </div>\n        \n        <div class=\"smch-health-section\">\n            <h4 class=\"smch-health-section-title\"><i class=\"material-icons\">door_sliding</i> Usage Habits</h4>\n             <div class=\"smch-health-indicators-grid\">\n                <div class=\"smch-health-indicator-card smch-health-gauge-card\">\n                    <div class=\"smch-health-indicator-label\">Usage Efficiency</div>\n                    <div class=\"smch-health-gauge-container\">\n                        <div class=\"smch-health-gauge-bg\"></div>\n                        <div class=\"smch-health-gauge-fill\" :style=\"efficiencyGauge.style\"></div>\n                        <div class=\"smch-health-gauge-center\"></div>\n                        <div class=\"smch-health-gauge-value\">{{ formatPercentage(usage.efficiency_score / 100, 0) }}</div>\n                    </div>\n                    <div class=\"smch-health-gauge-label\" :style=\"{ color: efficiencyGauge.color }\">\n                        {{ efficiencyGauge.label }}\n                    </div>\n                </div>\n                 <div class=\"smch-health-indicator-card smch-health-stats-card\">\n                     <div class=\"smch-health-stat-row\">\n                        <i class=\"material-icons smch-health-icon-secondary\">door_open</i>\n                        <span>Avg. Daily Openings</span>\n                        <strong>{{ formatNumber(usage.avg_daily_openings, 1) }}</strong>\n                    </div>\n                     <div class=\"smch-health-stat-row\">\n                        <i class=\"material-icons smch-health-icon-secondary\">timer</i>\n                        <span>Avg. Open Duration</span>\n                        <strong>{{ formatDuration(usage.avg_duration_seconds) }}</strong>\n                    </div>\n                    <div class=\"smch-health-stat-row\">\n                        <i class=\"material-icons smch-health-icon-secondary\">trending_up</i>\n                        <span>Usage Trend</span>\n                        <strong :class=\"'smch-health-trend-' + trends.usage_trend\">\n                           <i class=\"material-icons smch-health-trend-icon\">{{ getTrendIcon(trends.usage_trend) }}</i>\n                           {{ getTrendText(trends.usage_trend) }}\n                        </strong>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n    </div>\n    \n    <div v-else class=\"smch-health-state-overlay smch-health-no-data-state\">\n        <i class=\"material-icons smch-health-no-data-icon\">analytics</i>\n        <h4>No Data Available</h4>\n        <p>Waiting for data from the analysis service.</p>\n    </div>\n\n    <div class=\"smch-health-panel-footer\">\n        <div class=\"smch-health-data-summary\">\n             <i class=\"material-icons\">source</i>\n             Analyzed {{ dataSummary.temperature_points }} temp. points & {{ dataSummary.door_events }} door events\n        </div>\n        <button @click=\"requestRefresh\" class=\"smch-health-eco-button smch-health-refresh-btn\" :disabled=\"isLoading\">\n            <i class=\"material-icons\" :class=\"{ spinning: isLoading }\">refresh</i>\n        </button>\n    </div>\n</div>\n</template>\n\n<style>\n    /* === Variabili CSS Uniche per questo Pannello === */\n    :root {\n        --smch-health-panel-bg: #ffffff; \n        --smch-health-bg-color: #f8fafc; \n        --smch-health-text-primary: #1a2e3b;\n        --smch-health-text-secondary: #5a7184;\n        --smch-health-border-color: #e4ebf0; \n        --smch-health-status-online-bg: #e8f5e9;\n        --smch-health-status-online-text: #388e3c;\n        --smch-health-status-loading-bg: #fff8e1;\n        --smch-health-status-loading-text: #f57f17;\n        --smch-health-status-error-bg: #ffebee;\n        --smch-health-status-error-text: #d32f2f;\n        --smch-health-status-warning-bg: #FFF8E1; /* Giallo per warning */\n        --smch-health-status-warning-text: #FFA000;\n        --smch-health-accent-green: #4CAF50;\n        --smch-health-accent-yellow: #FFC107;\n        --smch-health-accent-red: #F44336;\n        --smch-health-accent-blue: #2196F3;\n        --smch-health-shadow: 0 4px 12px rgba(90, 113, 132, 0.08);\n    }\n\n    /* === Classi CSS Uniche === */\n    .smch-health-panel {\n        background: var(--smch-health-panel-bg);\n        border: 1px solid var(--smch-health-border-color);\n        border-radius: 12px;\n        padding: 20px;\n        color: var(--smch-health-text-primary);\n        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;\n        box-shadow: var(--smch-health-shadow);\n        position: relative;\n        min-height: 450px;\n        display: flex;\n        flex-direction: column;\n    }\n    .smch-health-panel-content { flex: 1; }\n\n    /* Header e Footer */\n    .smch-health-panel-header {\n        display: flex; justify-content: space-between; align-items: center;\n        padding-bottom: 16px; border-bottom: 1px solid var(--smch-health-border-color);\n        margin-bottom: 20px;\n    }\n    .smch-health-panel-title {\n        margin: 0; font-size: 1.25em; font-weight: 600;\n        display: flex; align-items: center; gap: 8px;\n    }\n    .smch-health-status-badge {\n        display: flex; align-items: center; gap: 6px;\n        padding: 6px 12px; border-radius: 20px;\n        font-size: 0.8em; font-weight: 600;\n    }\n    .smch-health-status-badge .smch-health-status-icon { font-size: 1.1em; }\n    .smch-health-status-badge.status-active { background: var(--smch-health-status-online-bg); color: var(--smch-health-status-online-text); }\n    .smch-health-status-badge.status-loading { background: var(--smch-health-status-loading-bg); color: var(--smch-health-status-loading-text); }\n    .smch-health-status-badge.status-error { background: var(--smch-health-status-error-bg); color: var(--smch-health-status-error-text); }\n    .smch-health-status-badge.status-warning { background: var(--smch-health-status-warning-bg); color: var(--smch-health-status-warning-text); } /* Stile Warning */\n    \n    .smch-health-panel-footer {\n        display: flex; justify-content: space-between; align-items: center;\n        padding-top: 16px; border-top: 1px solid var(--smch-health-border-color);\n        margin-top: 24px; font-size: 0.8em; color: var(--smch-health-text-secondary);\n    }\n    .smch-health-data-summary { display: flex; align-items: center; gap: 6px; }\n    .smch-health-data-summary i { font-size: 16px; }\n    .smch-health-eco-button { /* Bottone refresh */\n        background: transparent; border: none; color: var(--smch-health-text-secondary);\n        cursor: pointer; padding: 4px; border-radius: 50%; display: flex;\n        align-items: center; justify-content: center; transition: background 0.2s, color 0.2s;\n    }\n    .smch-health-eco-button i { font-size: 20px; }\n    .smch-health-eco-button:hover:not(:disabled) { background: var(--smch-health-border-color); color: var(--smch-health-text-primary); }\n    .smch-health-eco-button:disabled { cursor: not-allowed; opacity: 0.5; }\n    .spinning { animation: spin 1s linear infinite; }\n    @keyframes spin { 100% { transform: rotate(360deg); } }\n\n    /* Stati Overlay */\n    .smch-health-state-overlay {\n        position: absolute; top: 69px; left: 0; right: 0; bottom: 53px;\n        background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px);\n        display: flex; flex-direction: column; align-items: center; justify-content: center;\n        z-index: 10; text-align: center; padding: 20px;\n    }\n    .smch-health-state-overlay h4 { margin: 10px 0 5px 0; font-size: 1.1em; }\n    .smch-health-state-overlay p { margin: 0; color: var(--smch-health-text-secondary); }\n    .smch-health-error-icon, .smch-health-no-data-icon, .smch-health-warning-icon { font-size: 48px; }\n    .smch-health-error-icon { color: var(--smch-health-accent-red); }\n    .smch-health-no-data-icon { color: var(--smch-health-text-secondary); }\n    .smch-health-warning-icon { color: var(--smch-health-accent-yellow); } /* Giallo per warning */\n    .smch-health-spinner {\n        width: 36px; height: 36px; border: 4px solid var(--smch-health-border-color);\n        border-top: 4px solid var(--smch-health-accent-blue); border-radius: 50%;\n        animation: spin 1s linear infinite; margin-bottom: 16px;\n    }\n    .smch-health-retry-btn {\n        background: var(--smch-health-status-error-bg); color: var(--smch-health-status-error-text);\n        border-radius: 8px; padding: 8px 16px; margin-top: 20px; font-weight: 600;\n    }\n    .smch-health-retry-btn:hover { background: #ffcdd2; }\n\n    /* Layout Sezioni */\n    .smch-health-section { margin-bottom: 24px; }\n    .smch-health-section-title {\n        margin: 0 0 16px 0; font-size: 1.1em; font-weight: 600;\n        display: flex; align-items: center; gap: 8px; color: var(--smch-health-text-primary);\n    }\n    .smch-health-section-title i { color: var(--smch-health-text-secondary); }\n    .smch-health-period-info {\n        font-size: 0.85em; color: var(--smch-health-text-secondary);\n        margin-bottom: 20px; text-align: center;\n        background: var(--smch-health-bg-color); padding: 8px; border-radius: 6px;\n    }\n\n    /* Griglia Indicatori */\n    .smch-health-indicators-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));\n        gap: 16px;\n    }\n    .smch-health-indicator-card {\n        background: var(--smch-health-bg-color);\n        border: 1px solid var(--smch-health-border-color);\n        border-radius: 8px;\n        padding: 16px;\n    }\n    .smch-health-indicator-label {\n        font-size: 0.9em; font-weight: 600; color: var(--smch-health-text-secondary);\n        margin-bottom: 12px; text-align: center;\n    }\n    .smch-health-stats-card {\n        display: flex; flex-direction: column; justify-content: center; gap: 14px;\n    }\n    .smch-health-stat-row {\n        display: flex; align-items: center; justify-content: space-between; gap: 8px; font-size: 0.9em;\n    }\n    .smch-health-stat-row i.smch-health-icon-secondary {\n        font-size: 18px; color: var(--smch-health-text-secondary); opacity: 0.8;\n    }\n    .smch-health-stat-row strong { font-size: 1.1em; font-weight: 600; }\n    .smch-health-warn-text { color: var(--smch-health-accent-red); font-weight: 600; }\n\n    /* Gauge CSS */\n    .smch-health-gauge-card { display: flex; flex-direction: column; align-items: center; justify-content: space-between; min-height: 170px; }\n    .smch-health-gauge-container { width: 150px; height: 75px; position: relative; overflow: hidden; margin-bottom: 8px; }\n    .smch-health-gauge-bg, .smch-health-gauge-fill { width: 100%; height: 100%; position: absolute; border-top-left-radius: 150px; border-top-right-radius: 150px; }\n    .smch-health-gauge-bg { background: var(--smch-health-border-color); }\n    .smch-health-gauge-fill { background: linear-gradient(90deg, var(--smch-health-accent-green), var(--smch-health-accent-yellow), var(--smch-health-accent-red)); transform-origin: 50% 100%; transition: transform 0.5s ease; }\n    .smch-health-gauge-center { width: 80%; height: 80%; background: var(--smch-health-panel-bg); position: absolute; bottom: 0; left: 10%; border-top-left-radius: 150px; border-top-right-radius: 150px; }\n    .smch-health-gauge-value { position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 1.8em; font-weight: 700; z-index: 1; }\n    .smch-health-gauge-label { font-size: 0.9em; font-weight: 600; transition: color 0.5s ease; text-align: center; }\n\n    /* Stili Trend */\n    .smch-health-trend-icon { font-size: 1.1em !important; vertical-align: bottom; }\n    .smch-health-trend-increasing { color: var(--smch-health-accent-red); }\n    .smch-health-trend-stable { color: var(--smch-health-accent-blue); }\n    .smch-health-trend-decreasing { color: var(--smch-health-accent-green); }\n\n</style>\n\n<script>\nexport default {\n    data() {\n        return {\n            isLoading: false,\n            hasError: false,\n            errorMessage: '',\n            lastUpdate: null,\n            // Inizializza con la struttura dati vuota (presa dal tuo function node)\n            temperature: {},\n            usage: {},\n            trends: {},\n            dataSummary: {},\n            analysisInfo: {} \n        }\n    },\n    computed: {\n        // Aggiunto controllo per 'isUnreliable' basato su dati minimi\n         isUnreliable() {\n            // Considera i dati inaffidabili se ci sono pochissimi punti o eventi\n            return !this.isLoading && \n                   !this.hasError && \n                   this.hasData && // Controlla solo se abbiamo ricevuto *qualcosa*\n                   ( (this.dataSummary.temperature_points || 0) < 50 || \n                     (this.dataSummary.door_events || 0) < 5 ); \n        },\n        hasData() {\n            // Dati considerati validi se c'√® almeno uno score di stabilit√†\n            return this.temperature && this.temperature.stability_score !== undefined;\n        },\n        statusClass() {\n            if (this.isLoading) return 'status-loading';\n            if (this.hasError) return 'status-error';\n            // Aggiunto stato warning\n            if (this.isUnreliable) return 'status-warning'; \n            return 'status-active';\n        },\n        statusText() {\n            if (this.isLoading) return 'Analyzing...';\n            if (this.hasError) return 'Error';\n            // Aggiunto stato warning\n            if (this.isUnreliable) return 'Low Data'; \n            return 'Active';\n        },\n        statusIcon() {\n            if (this.isLoading) return 'hourglass_top';\n            if (this.hasError) return 'error';\n             // Aggiunto stato warning\n            if (this.isUnreliable) return 'warning_amber';\n            return 'check_circle';\n        },\n        stabilityGauge() {\n            const score = this.temperature.stability_score || 0;\n            const percentage = Math.min(1, score / 100); \n            \n            let color = 'var(--smch-health-accent-green)';\n            let label = 'Excellent';\n            if (score < 70) {\n                color = 'var(--smch-health-accent-red)';\n                label = 'Poor (Check)';\n            } else if (score < 85) {\n                color = 'var(--smch-health-accent-yellow)';\n                label = 'Fair';\n            }\n            \n            return {\n                style: { transform: `rotate(${(percentage * 180)}deg)` },\n                color: color, label: label\n            };\n        },\n        efficiencyGauge() {\n            const score = this.usage.efficiency_score || 0;\n            const percentage = Math.min(1, score / 100);\n            \n            let color = 'var(--smch-health-accent-green)';\n            let label = 'Efficient Use';\n             if (score < 70) {\n                color = 'var(--smch-health-accent-red)';\n                label = 'Inefficient (Improve)';\n            } else if (score < 85) {\n                color = 'var(--smch-health-accent-yellow)';\n                label = 'Moderate';\n            }\n            \n            return {\n                style: { transform: `rotate(${(percentage * 180)}deg)` },\n                color: color, label: label\n            };\n        }\n    },\n    methods: {\n        formatTemp(value) {\n            if (value === null || value === undefined) return '--¬∞C';\n            return Number(value).toFixed(1) + '¬∞C';\n        },\n         formatNumber(value, decimals = 1) {\n            if (value === null || value === undefined) return '--';\n            return Number(value).toFixed(decimals);\n        },\n        formatPercentage(value, decimals = 0) {\n            if (value === null || value === undefined) return '--%';\n            return (value * 100).toFixed(decimals) + '%';\n        },\n        formatDuration(seconds) {\n            if (seconds === null || seconds === undefined) return '--';\n            if (seconds < 60) return Math.round(seconds) + ' sec';\n            return Math.round(seconds / 60) + ' min';\n        },\n        getTrendIcon(trend) {\n            if (trend === 'increasing') return 'trending_up';\n            if (trend === 'decreasing') return 'trending_down';\n            return 'trending_flat';\n        },\n        getTrendText(trend) {\n            if (trend === 'increasing') return 'Increasing';\n            if (trend === 'decreasing') return 'Decreasing';\n            return 'Stable';\n        },\n        formatTimestamp(isoString) {\n            if (!isoString) return 'Never';\n            try {\n                return new Date(isoString).toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });\n            } catch (e) { return 'Just now'; }\n        },\n        requestRefresh() {\n            this.send({ topic: 'request_analysis_refresh', payload: true });\n        }\n    },\n    watch: {\n        msg: {\n            handler(newMsg) {\n                if (!newMsg) return;\n\n                if (newMsg.loading) { this.isLoading = true; this.hasError = false; return; } \n                if (newMsg.error) { this.isLoading = false; this.hasError = true; this.errorMessage = newMsg.error; return; }\n                \n                if (newMsg.payload && typeof newMsg.payload === 'object' && newMsg.topic === 'analysis_update') {\n                    this.isLoading = false;\n                    const data = newMsg.payload; \n\n                    if (data.error) {\n                        this.hasError = true;\n                        this.errorMessage = data.error;\n                        return;\n                    }\n\n                    this.hasError = false;\n                    this.lastUpdate = data.timestamp; \n\n                    // Mappa i dati (con fallback per sicurezza)\n                    this.temperature = data.temperature_analysis || {};\n                    this.usage = data.usage_analysis || {};\n                    this.trends = data.trends || {};\n                    this.dataSummary = data.data_summary || {};\n                    this.analysisInfo = data.analysis_info || {}; \n                }\n            },\n            immediate: true,\n            deep: true \n        }\n    }\n}\n</script>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 600,
        "y": 680,
        "wires": [
            []
        ]
    },
    {
        "id": "85c8cd9e15241e42",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Prepare Data Requests",
        "func": "const userSession = global.get('user_session');\nif (!userSession || !userSession.deviceId) {\n    node.warn(\"No valid user session or device ID\");\n    return null;\n}\n\nconst deviceId = userSession.deviceId;\n\n// Richiesta completa al Data Analysis Service\nconst msgAnalysis = {\n    payload: '',\n    url: `http://data_analysis:8004/analyze/${deviceId}`,\n    method: 'GET',\n    headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json'\n    },\n    topic: 'data_analysis',\n    device_id: deviceId,\n    timestamp: new Date().toISOString()\n};\n\n// URL parameters per dati completi\nmsgAnalysis.url += '?period=1d&metrics=temperature,usage_patterns,trends';\n\nnode.log(`Requesting data analysis for device: ${deviceId}`);\nnode.log(`URL: ${msgAnalysis.url}`);\n\nreturn msgAnalysis;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 390,
        "y": 760,
        "wires": [
            [
                "026cfa398b568558"
            ]
        ],
        "outputLabels": [
            "data_analysis_full"
        ]
    },
    {
        "id": "026cfa398b568558",
        "type": "http request",
        "z": "dashboard_tab",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 630,
        "y": 760,
        "wires": [
            [
                "8d4758a1a5051344",
                "b6d994977ac1a479"
            ]
        ]
    },
    {
        "id": "8d4758a1a5051344",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Process Data",
        "func": "// Gestione loading state\nconst loadingMsg = {\n    payload: null,\n    loading: true,\n    error: false\n};\n\n// Verifica status HTTP\nif (msg.statusCode && msg.statusCode !== 200) {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: `Data Analysis Service non disponibile (HTTP ${msg.statusCode})`,\n        statusCode: msg.statusCode\n    };\n\n    node.error(`HTTP Error ${msg.statusCode} from Data Analysis Service`);\n    return errorMsg;\n}\n\n// Verifica dati validi\nconst rawData = msg.payload;\nif (!rawData || typeof rawData !== 'object') {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: \"Dati non validi ricevuti dal servizio\"\n    };\n\n    node.error(\"Invalid data received from Data Analysis Service\");\n    return errorMsg;\n}\n\n// Verifica errori nel payload\nif (rawData.error) {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: rawData.error || \"Errore sconosciuto dal servizio\"\n    };\n\n    node.error(`Service error: ${rawData.error}`);\n    return errorMsg;\n}\n\n// Processa i dati per UI\ntry {\n    const processedData = {\n        loading: false,\n        error: false,\n        timestamp: new Date().toISOString(),\n        device_id: rawData.device_id || msg.device_id,\n\n        payload: {\n            temperature_analysis: rawData.temperature_analysis || {},\n            usage_analysis: rawData.usage_analysis || {},\n            trends: rawData.trends || {},\n            data_summary: rawData.data_summary || {},\n\n            // Metadata\n            analysis_info: {\n                period: rawData.period || '7d',\n                analysis_timestamp: rawData.analysis_timestamp,\n                service: rawData.service || 'data_analysis'\n            }\n        }\n    };\n\n    // Log per debugging\n    node.log(`Processed analysis data for ${processedData.device_id}`);\n    if (rawData.temperature_analysis) {\n        node.log(`- Avg temp: ${rawData.temperature_analysis.avg_temperature}¬∞C`);\n        node.log(`- Stability: ${rawData.temperature_analysis.stability_score}%`);\n    }\n    if (rawData.usage_analysis) {\n        node.log(`- Daily openings: ${rawData.usage_analysis.avg_daily_openings}`);\n        node.log(`- Usage efficiency: ${rawData.usage_analysis.efficiency_score}%`);\n    }\n\n    return processedData;\n\n} catch (error) {\n    const errorMsg = {\n        payload: null,\n        loading: false,\n        error: `Errore elaborazione dati: ${error.message}`\n    };\n\n    node.error(`Error processing analysis data: ${error.message}`, msg);\n    return errorMsg;\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 840,
        "y": 760,
        "wires": [
            [
                "f358f0ed0611f2cf"
            ]
        ]
    },
    {
        "id": "4cde73836a93b603",
        "type": "ui-text",
        "z": "dashboard_tab",
        "group": "hero_group",
        "order": 7,
        "width": 12,
        "height": 2,
        "name": "Graphic Text",
        "label": "Chart Section",
        "format": "{{msg.payload}}",
        "layout": "row-center",
        "style": true,
        "font": "Copperplate,Copperplate Gothic Light,fantasy",
        "fontSize": "28",
        "color": "#717171",
        "wrapText": false,
        "className": "Charts Section",
        "x": 570,
        "y": 840,
        "wires": []
    },
    {
        "id": "98a075e11c669678",
        "type": "ui-chart",
        "z": "dashboard_tab",
        "group": "hero_group",
        "name": "Chart",
        "label": "",
        "order": 12,
        "chartType": "line",
        "category": "topic",
        "categoryType": "msg",
        "xAxisLabel": "",
        "xAxisProperty": "timestamp",
        "xAxisPropertyType": "property",
        "xAxisType": "time",
        "xAxisFormat": "",
        "xAxisFormatType": "HH:mm:ss",
        "xmin": "",
        "xmax": "",
        "yAxisLabel": "",
        "yAxisProperty": "value",
        "yAxisPropertyType": "property",
        "ymin": "0",
        "ymax": "",
        "bins": 10,
        "action": "append",
        "stackSeries": false,
        "pointShape": "circle",
        "pointRadius": "4",
        "showLegend": true,
        "removeOlder": 1,
        "removeOlderUnit": "604800",
        "removeOlderPoints": "",
        "colors": [
            "#0095ff",
            "#ff0000",
            "#ff7f0e",
            "#2ca02c",
            "#a347e1",
            "#d62728",
            "#ff9896",
            "#9467bd",
            "#c5b0d5"
        ],
        "textColor": [
            "#666666"
        ],
        "textColorDefault": true,
        "gridColor": [
            "#e5e5e5"
        ],
        "gridColorDefault": true,
        "width": 8,
        "height": 10,
        "className": "",
        "interpolation": "linear",
        "x": 570,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "cd28e2983a3853b5",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Prapare Chart Data",
        "func": "const userSession = global.get('user_session');\nlet period = flow.get(\"period\") || \"7d\";\nlet data = flow.get(\"chartData\") || \"Temperature\"; // This value will come from the UI selector\n\nif (!userSession) {\n    // No session -> stop flow\n    return null;\n}\n\nconst deviceId = userSession.deviceId;\n\nlet topic;\nlet url;\nlet sensorType; // Variable to hold the actual sensor name or 'events'\n\n// Normalize the topic and URL based on the selected data\nswitch (data.toLowerCase()) {\n    case \"temperature\":\n        topic = \"temperature_data\";\n        sensorType = \"temperature\";\n        url = `http://influxdb_adaptor:8002/sensors/${sensorType}?device=${deviceId}&last=${period}`;\n        break;\n    case \"humidity\":\n        topic = \"humidity_data\";\n        sensorType = \"humidity\";\n        url = `http://influxdb_adaptor:8002/sensors/${sensorType}?device=${deviceId}&last=${period}`;\n        break;\n    case \"gas\":\n        topic = \"gas_data\";\n        sensorType = \"gas\";\n        url = `http://influxdb_adaptor:8002/sensors/${sensorType}?device=${deviceId}&last=${period}`;\n        break;\n\n    // *** NEW CASE FOR DOOR OPENINGS ***\n    case \"door events\": // Or \"openings\", \"door\", etc. - match your UI selector value\n        topic = \"door_event_data\";\n        sensorType = \"events\"; // Use 'events' to signify it's not a sensor\n        url = `http://influxdb_adaptor:8002/events?device=${deviceId}&last=${period}`; // Use the /events endpoint\n        break;\n\n    default:\n        node.warn(`Unknown data type requested: ${data}`);\n        return null; // Stop if the type isn't recognized\n}\n\n// Construct the message for the HTTP Request node\nconst msgInflux = {\n    payload: '', // Empty for GET\n    url: url,    // Use the URL constructed above\n    method: 'GET',\n    topic: topic // Set the topic for the response\n};\n\nreturn msgInflux;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 1000,
        "wires": [
            [
                "5ff513455a541c34"
            ]
        ]
    },
    {
        "id": "5ff513455a541c34",
        "type": "http request",
        "z": "dashboard_tab",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 550,
        "y": 1000,
        "wires": [
            [
                "2c73adf9d6b7abcd",
                "ed32c352e03f8407"
            ]
        ]
    },
    {
        "id": "2c73adf9d6b7abcd",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Process Data",
        "func": "// Map topics to user-friendly series names for the chart\nconst mapSeriesName = {\n     temperature_data: \"Temperature\",\n     humidity_data: \"Humidity\",\n     gas_data: \"Gas\",\n     door_event_data: \"Door Openings\" // Added series name for door events\n};\n\n// If the topic isn't recognized, discard the message\nif (!mapSeriesName[msg.topic]) {\n     node.warn(\"Unknown topic received: \" + msg.topic);\n     return null; // Discard unknown topics\n}\n\nconst series = mapSeriesName[msg.topic];\nlet points = [];\n\n// --- Data Extraction Logic ---\n\nif (msg.topic === \"door_event_data\") {\n     // Handle the specific structure from the /events endpoint: { \"events\": [...] }\n     const events = msg.payload?.events || [];\n     points = events\n          .filter(event => event.event_type === \"door_opened\") // Only chart when the door opens\n          .map(event => ({\n               timestamp: event.timestamp * 1000, // Convert Unix seconds to milliseconds\n               value: 1                          // Assign a value of 1 to represent an opening event\n          }));\n     node.log(`Processing ${points.length} door opening events for chart`);\n\n} else {\n     // Handle the SenML structure from /sensors endpoints: { \"e\": [...] }\n     const senmlEntries = msg.payload?.e || [];\n     points = senmlEntries.map(p => ({\n          timestamp: p.t * 1000, // Convert Unix seconds to milliseconds\n          value: p.v             // Use the sensor value\n     }));\n     node.log(`Processing ${points.length} sensor points for chart (${series})`);\n}\n\n// If no points were extracted, stop\nif (points.length === 0) {\n     node.log(\"No valid data points found for topic: \" + msg.topic);\n     return null;\n}\n\n// Prepare the message for the ui_chart node\nconst outMsg = {\n     topic: series,      // Series name (e.g., \"Temperature\", \"Door Openings\")\n     action: \"append\",   // Add points to the chart\n     payload: points     // Array of { timestamp: ms, value: y }\n};\n\nreturn outMsg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1000,
        "wires": [
            [
                "98a075e11c669678",
                "1bb39d5861ebcbd4"
            ]
        ],
        "outputLabels": [
            "Temp/Hum",
            ""
        ]
    },
    {
        "id": "1bb39d5861ebcbd4",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 9",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 1040,
        "y": 940,
        "wires": []
    },
    {
        "id": "87c3519ce88d036e",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Prepare Chart",
        "func": "// Questo nodo serve per resettare il grafico\n// e prepararlo a ricevere nuovi dati\n\n// payload vuoto = cancella dati esistenti\nmsg.payload = [];\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 340,
        "y": 920,
        "wires": [
            [
                "cd28e2983a3853b5",
                "98a075e11c669678"
            ]
        ]
    },
    {
        "id": "ed32c352e03f8407",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 10",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 720,
        "y": 1100,
        "wires": []
    },
    {
        "id": "d0fb446a71eb3205",
        "type": "ui-button-group",
        "z": "dashboard_tab",
        "name": "Scelta Periodo",
        "group": "hero_group",
        "order": 10,
        "width": 4,
        "height": "2",
        "label": "",
        "className": "",
        "rounded": true,
        "useThemeColors": true,
        "passthru": false,
        "options": [
            {
                "label": "1h",
                "icon": "",
                "value": "1h",
                "valueType": "str",
                "color": "#009999"
            },
            {
                "label": "6h",
                "icon": "",
                "value": "6h",
                "valueType": "str",
                "color": "#cccc00"
            },
            {
                "label": "12h",
                "icon": "",
                "value": "12h",
                "valueType": "str",
                "color": "#009933"
            },
            {
                "label": "24h",
                "icon": "",
                "value": "24h",
                "valueType": "str",
                "color": "#999999"
            },
            {
                "label": "7d",
                "icon": "",
                "value": "7d",
                "valueType": "str",
                "color": "#ff6666"
            }
        ],
        "topic": "topic",
        "topicType": "msg",
        "x": 160,
        "y": 1160,
        "wires": [
            [
                "37d79cce78448b1c"
            ]
        ]
    },
    {
        "id": "37d79cce78448b1c",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Save Chart Period",
        "func": "flow.set(\"period\", msg.payload);\nreturn msg;\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 1160,
        "wires": [
            [
                "87c3519ce88d036e"
            ]
        ]
    },
    {
        "id": "6dec62f98375d4a9",
        "type": "ui-button-group",
        "z": "dashboard_tab",
        "name": "Scelta Sensor Data",
        "group": "hero_group",
        "order": 9,
        "width": 5,
        "height": "2",
        "label": "",
        "className": "",
        "rounded": false,
        "useThemeColors": true,
        "passthru": false,
        "options": [
            {
                "label": "Temperature",
                "icon": "",
                "value": "temperature",
                "valueType": "str",
                "color": "#009933"
            },
            {
                "label": "Humidity",
                "icon": "",
                "value": "humidity",
                "valueType": "str",
                "color": "#999999"
            },
            {
                "label": "Gas",
                "icon": "",
                "value": "gas",
                "valueType": "str",
                "color": "#ff6666"
            },
            {
                "label": "Door Openings",
                "icon": "",
                "value": "door events",
                "valueType": "str",
                "color": "#009999"
            }
        ],
        "topic": "topic",
        "topicType": "msg",
        "x": 150,
        "y": 1100,
        "wires": [
            [
                "e2b08edd27e86a9f"
            ]
        ]
    },
    {
        "id": "e2b08edd27e86a9f",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Save Chart Data",
        "func": "flow.set(\"chartData\", msg.payload);\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 1100,
        "wires": [
            [
                "87c3519ce88d036e"
            ]
        ]
    },
    {
        "id": "e9fd020c623e582a",
        "type": "inject",
        "z": "dashboard_tab",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "chartData",
        "payloadType": "flow",
        "x": 120,
        "y": 1020,
        "wires": [
            [
                "6dec62f98375d4a9"
            ]
        ]
    },
    {
        "id": "a24d755c46914786",
        "type": "inject",
        "z": "dashboard_tab",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": true,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "period",
        "payloadType": "flow",
        "x": 110,
        "y": 1240,
        "wires": [
            [
                "d0fb446a71eb3205"
            ]
        ]
    },
    {
        "id": "4d8d3ef346dda84b",
        "type": "ui-button",
        "z": "dashboard_tab",
        "group": "hero_group",
        "name": "",
        "label": "Settings",
        "order": 3,
        "width": 1,
        "height": 1,
        "emulateClick": false,
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "cog",
        "iconPosition": "left",
        "payload": "SmartChill Settings",
        "payloadType": "str",
        "topic": "payload",
        "topicType": "msg",
        "buttonColor": "#34495e",
        "textColor": "",
        "iconColor": "",
        "enableClick": true,
        "enablePointerdown": false,
        "pointerdownPayload": "",
        "pointerdownPayloadType": "str",
        "enablePointerup": false,
        "pointerupPayload": "",
        "pointerupPayloadType": "str",
        "x": 1440,
        "y": 80,
        "wires": [
            [
                "e3930301124a4cb4",
                "100110691354da8c"
            ]
        ]
    },
    {
        "id": "e3930301124a4cb4",
        "type": "ui-control",
        "z": "dashboard_tab",
        "name": "Change Page",
        "ui": "ui_base",
        "events": "all",
        "x": 1660,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "3137777780ba70f8",
        "type": "ui-template",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "page": "",
        "ui": "",
        "name": "Timer Service",
        "order": 5,
        "width": "4",
        "height": "18",
        "head": "",
        "format": "<template>\n  <div\n    style=\"padding: 60px 40px; max-width: 800px; margin: 0 auto; background: white; min-height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden;\">\n    <div style=\"background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;\">\n\n      <!-- Header -->\n      <div\n        style=\"padding: 40px 40px 30px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #e9ecef;\">\n        <h1 style=\"color: #2c3e50; font-size: 1.75rem; font-weight: 300; margin: 0 0 8px 0; letter-spacing: -0.5px;\">\n          Timer Configuration\n        </h1>\n        <p style=\"color: #6c757d; font-size: 0.95rem; margin: 0; font-weight: 400;\">\n          Configure door monitoring settings for optimal performance\n        </p>\n      </div>\n\n      <!-- Content -->\n      <div style=\"padding: 40px;\">\n\n        <!-- Door Timeout Setting -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Door Open Timeout\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Maximum duration the door can remain open before triggering an alert\n            </p>\n          </div>\n          <v-text-field v-model.number=\"currentConfig.maxDoorOpen\" type=\"number\" :min=\"30\" :max=\"300\" variant=\"outlined\"\n            hide-details=\"auto\" style=\"margin-top: 8px;\" density=\"comfortable\">\n            <template v-slot:append-inner>\n              <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">seconds</span>\n            </template>\n          </v-text-field>\n          <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n            Valid range: 30-300 seconds\n          </div>\n        </div>\n\n        <!-- Check Interval Setting -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Check Interval\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Frequency of monitoring checks for door violations\n            </p>\n          </div>\n          <v-text-field v-model.number=\"currentConfig.checkInterval\" type=\"number\" :min=\"1\" :max=\"30\" variant=\"outlined\"\n            hide-details=\"auto\" style=\"margin-top: 8px;\" density=\"comfortable\">\n            <template v-slot:append-inner>\n              <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">seconds</span>\n            </template>\n          </v-text-field>\n          <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n            Valid range: 1-30 seconds\n          </div>\n        </div>\n\n        <!-- Alerts Setting -->\n        <div style=\"margin-bottom: 40px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Door Closed Alerts\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Send notification when door closes after exceeding timeout\n            </p>\n          </div>\n          <v-select v-model=\"currentConfig.enableClosedAlerts\" :items=\"[\n              { title: 'Enabled', value: 'Enabled' },\n              { title: 'Disabled', value: 'Disabled' }\n            ]\" variant=\"outlined\" hide-details=\"auto\" style=\"margin-top: 8px;\" density=\"comfortable\"></v-select>\n        </div>\n\n        <!-- Action Button -->\n        <div style=\"display: flex; justify-content: center; margin-top: 40px;\">\n          <v-btn color=\"#2c3e50\" size=\"large\" style=\"\n              padding: 12px 32px; \n              font-size: 0.95rem; \n              border-radius: 6px; \n              text-transform: none; \n              font-weight: 500;\n              letter-spacing: 0.25px;\n              min-width: 160px;\n            \" @click=\"sendConfig\" :disabled=\"!isConfigValid\" :loading=\"isWaitingResponse\" elevation=\"1\">\n            Apply Settings\n          </v-btn>\n        </div>\n\n        <!-- Status Message -->\n        <div v-if=\"statusMessage\" style=\"margin-top: 24px;\">\n          <div :style=\"{\n            padding: '16px 20px',\n            borderRadius: '6px',\n            backgroundColor: statusError ? '#fff5f5' : '#f0f9ff',\n            border: statusError ? '1px solid #fecaca' : '1px solid #bae6fd',\n            fontSize: '0.875rem',\n            lineHeight: '1.4'\n          }\">\n            <div :style=\"{\n              color: statusError ? '#dc2626' : '#0369a1',\n              fontWeight: '500'\n            }\">\n              {{ statusMessage }}\n            </div>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\n  export default {\n  data() {\n    return {\n      currentConfig: {\n        maxDoorOpen: 60,\n        checkInterval: 5,\n        enableClosedAlerts: \"Enabled\"\n      },\n      lastValidConfig: {\n        maxDoorOpen: 60,\n        checkInterval: 5,\n        enableClosedAlerts: \"Enabled\"\n      },\n      statusMessage: \"\",\n      statusError: false,\n      isWaitingResponse: false\n    }\n  },\n  \n  computed: {\n    isConfigValid() {\n      return (\n        this.currentConfig.maxDoorOpen >= 30 && \n        this.currentConfig.maxDoorOpen <= 300 &&\n        this.currentConfig.checkInterval >= 1 && \n        this.currentConfig.checkInterval <= 30\n      );\n    }\n  },\n  \n  watch: {\n    msg: {\n      handler(newMsg) {\n        if (newMsg && newMsg.topic) {\n          console.log(\"RECEIVED MESSAGE:\", newMsg);\n          \n          if (newMsg.topic === \"config_ack\") {\n            this.handleConfigSuccess(newMsg);\n          } else if (newMsg.topic === \"config_error\") {\n            this.handleConfigError(newMsg);\n          } else if (newMsg.topic === \"config_data\") {\n            this.handleConfigData(newMsg);\n          }\n        }\n      },\n      deep: true,\n      immediate: true\n    }\n  },\n  \n  methods: {\n    sendConfig() {\n      if (!this.isConfigValid) {\n        this.statusMessage = \"Please verify all values are within the specified ranges\";\n        this.statusError = true;\n        return;\n      }\n      \n      this.isWaitingResponse = true;\n      const deviceId = this.msg?.deviceId || \"unknown_device\";\n      \n      const message = {\n        type: \"device_config_update\",\n        device_id: deviceId,\n        config: {\n          max_door_open_seconds: parseInt(this.currentConfig.maxDoorOpen),\n          check_interval: parseInt(this.currentConfig.checkInterval),\n          enable_door_closed_alerts: (this.currentConfig.enableClosedAlerts === 'Enabled')\n        }\n      };\n      \n      this.send({\n        topic: `Group17/SmartChill/TimerUsageControl/${deviceId}/config_update`,\n        payload: message\n      });\n      \n      this.statusMessage = \"Applying configuration changes...\";\n      this.statusError = false;\n      \n      setTimeout(() => {\n        if (this.isWaitingResponse) {\n          this.statusMessage = \"Configuration request timed out - please verify device connectivity\";\n          this.statusError = true;\n          this.isWaitingResponse = false;\n        }\n      }, 10000);\n    },\n    \n    handleConfigData(msg) {\n      console.log(\"Loading config data:\", msg.payload);\n      \n      const cfg = msg.payload.config || {};\n      \n      // Popola i campi con i dati reali dal servizio\n      if (cfg.max_door_open_seconds !== undefined) {\n        this.currentConfig.maxDoorOpen = cfg.max_door_open_seconds;\n      }\n      if (cfg.check_interval !== undefined) {\n        this.currentConfig.checkInterval = cfg.check_interval;\n      }\n      if (cfg.enable_door_closed_alerts !== undefined) {\n        this.currentConfig.enableClosedAlerts = cfg.enable_door_closed_alerts ? \"Enabled\" : \"Disabled\";\n      }\n      \n      // Salva come configurazione valida (per eventuali rollback)\n      this.lastValidConfig = { ...this.currentConfig };\n      \n      this.statusMessage = \"Configuration loaded successfully\";\n      this.statusError = false;\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n      }, 2000);\n    },\n    \n    handleConfigSuccess(msg) {\n      this.isWaitingResponse = false;\n      this.statusMessage = \"Configuration has been successfully applied to the device\";\n      this.statusError = false;\n      \n      const cfg = msg.payload.config || {};\n      if (cfg.max_door_open_seconds !== undefined) {\n        this.currentConfig.maxDoorOpen = cfg.max_door_open_seconds;\n      }\n      if (cfg.check_interval !== undefined) {\n        this.currentConfig.checkInterval = cfg.check_interval;\n      }\n      if (cfg.enable_door_closed_alerts !== undefined) {\n        this.currentConfig.enableClosedAlerts = cfg.enable_door_closed_alerts ? \"Enabled\" : \"Disabled\";\n      }\n      \n      this.lastValidConfig = { ...this.currentConfig };\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n      }, 4000);\n    },\n    \n    handleConfigError(msg) {\n      this.isWaitingResponse = false;\n      const errorMsg = msg.payload.error_message || \"An unexpected error occurred\";\n      this.statusMessage = `Configuration failed: ${errorMsg}`;\n      this.statusError = true;\n      \n      this.currentConfig = { ...this.lastValidConfig };\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n        this.statusError = false;\n      }, 6000);\n    }\n  }\n}\n</script>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 2060,
        "y": 200,
        "wires": [
            [
                "9e4b44d8a8567105"
            ]
        ]
    },
    {
        "id": "9e4b44d8a8567105",
        "type": "mqtt out",
        "z": "dashboard_tab",
        "name": "",
        "topic": "",
        "qos": "2",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "cae7e64b62c3d84e",
        "x": 2310,
        "y": 300,
        "wires": []
    },
    {
        "id": "ebed8b9933d4ecd8",
        "type": "mqtt in",
        "z": "dashboard_tab",
        "name": "Error",
        "topic": "Group17/SmartChill/TimerUsageControl/+/config_error",
        "qos": "0",
        "datatype": "json",
        "broker": "cae7e64b62c3d84e",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 1510,
        "y": 400,
        "wires": [
            [
                "e44f892c1ef24df1"
            ]
        ]
    },
    {
        "id": "e5ec5118f42ac7a5",
        "type": "mqtt in",
        "z": "dashboard_tab",
        "name": "Ack",
        "topic": "Group17/SmartChill/+/+/config_ack",
        "qos": "0",
        "datatype": "json",
        "broker": "cae7e64b62c3d84e",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 1510,
        "y": 340,
        "wires": [
            [
                "e44f892c1ef24df1"
            ]
        ]
    },
    {
        "id": "ffc8bf0e0acdfc69",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 12",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1960,
        "y": 140,
        "wires": []
    },
    {
        "id": "c002d98e55aeb287",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Handle Config Request",
        "func": "// Function Node: Handle Config Response\n// Routes config_data to appropriate UI template based on service\n\nconst session = global.get('user_session');\nconst deviceId = session?.deviceId || \"unknown_device\";\n\nlet outputIndex = null;\nlet out = null;\n\n// Determine which service sent the response\nif (msg.topic.includes(\"TimerUsageControl\")) {\n    outputIndex = 0; // First output -> Timer Control template\n} else if (msg.topic.includes(\"FridgeStatusControl\")) {\n    outputIndex = 1; // Second output -> Fridge Status template  \n} else if (msg.topic.includes(\"FoodSpoilageControl\")) {\n    outputIndex = 2; // Third output -> Food Spoilage template\n}\n\n// Process only config_data messages\nif (outputIndex !== null && msg.topic.includes(\"config_data\")) {\n    out = {\n        topic: \"config_data\",\n        deviceId: deviceId,\n        payload: {\n            data_type: msg.payload.data_type || \"device_config\",\n            config: msg.payload.config || {},\n            timestamp: msg.payload.timestamp,\n            config_version: msg.payload.config_version\n        }\n    };\n}\n\n// Create output array\nif (out && outputIndex !== null) {\n    const outputs = [];\n    for (let i = 0; i < 3; i++) { // 3 outputs for 3 services\n        outputs[i] = (i === outputIndex) ? out : null;\n    }\n    return outputs;\n}\n\n// If not recognized or error -> discard\nreturn [null, null, null];",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1710,
        "y": 280,
        "wires": [
            [
                "3137777780ba70f8",
                "ffc8bf0e0acdfc69"
            ],
            [
                "e8f94f42edd2088b",
                "ffc8bf0e0acdfc69"
            ],
            [
                "4178a5ac06561322",
                "ffc8bf0e0acdfc69"
            ]
        ],
        "outputLabels": [
            "TimerUsageControl",
            "FridgeStatusControl",
            "FoodSpoilageControl"
        ]
    },
    {
        "id": "e44f892c1ef24df1",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Handle",
        "func": "const session = global.get('user_session');\nconst deviceId = session?.deviceId || \"unknown_device\";\n\nlet out = null;\nlet outputIndex = null;\n\n// Determina quale servizio ha inviato il messaggio\nif (msg.topic.includes(\"TimerUsageControl\")) {\n    outputIndex = 0; // Prima uscita -> Timer Control template\n} else if (msg.topic.includes(\"FridgeStatusControl\")) {\n    outputIndex = 1; // Seconda uscita -> Fridge Status template\n} else if (msg.topic.includes(\"FoodSpoilageControl\")) {\n    outputIndex = 2; // Terza uscita -> Food Spoilage template\n}\n// else if (msg.topic.includes(\"EnergyOptimization\")) {\n//     outputIndex = 3; // Quarta uscita -> Energy Optimization template\n// }\n\n// Processa solo se abbiamo identificato un servizio\nif (outputIndex !== null) {\n    if (msg.topic.includes(\"config_ack\")) {\n        out = {\n            topic: \"config_ack\",\n            deviceId: deviceId,\n            payload: {\n                status: msg.payload.status || \"device_updated\",\n                config: msg.payload.config || {}\n            }\n        };\n    }\n    else if (msg.topic.includes(\"config_error\")) {\n        out = {\n            topic: \"config_error\",\n            deviceId: deviceId,\n            payload: {\n                error_message: msg.payload.error_message || \"Unknown error\"\n            }\n        };\n    }\n}\n\n// Crea array di output con il messaggio nella posizione corretta\nif (out && outputIndex !== null) {\n    const outputs = [];\n    for (let i = 0; i < 4; i++) { // Aumenta il numero se aggiungi pi√π servizi\n        outputs[i] = (i === outputIndex) ? out : null;\n    }\n    return outputs;\n}\n\n// Se non riconosciuto o errore -> scarta\nreturn [null, null, null, null]; // Adatta il numero alle tue uscite",
        "outputs": 4,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1700,
        "y": 360,
        "wires": [
            [
                "3137777780ba70f8"
            ],
            [
                "e8f94f42edd2088b"
            ],
            [
                "4178a5ac06561322"
            ],
            []
        ],
        "outputLabels": [
            "TimerServiceControl",
            "FridgeStatus",
            "FoodSpoilageControl",
            ""
        ]
    },
    {
        "id": "e8f94f42edd2088b",
        "type": "ui-template",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "page": "",
        "ui": "",
        "name": "Fridge Status",
        "order": 4,
        "width": "4",
        "height": "18",
        "head": "",
        "format": "<template>\n  <div\n    style=\"padding: 60px 40px; max-width: 800px; margin: 0 auto; background: white; min-height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden;\">\n    <div style=\"background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;\">\n\n      <!-- Header -->\n      <div\n        style=\"padding: 40px 40px 30px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #e9ecef;\">\n        <h1 style=\"color: #2c3e50; font-size: 1.75rem; font-weight: 300; margin: 0 0 8px 0; letter-spacing: -0.5px;\">\n          Status Control Configuration\n        </h1>\n        <p style=\"color: #6c757d; font-size: 0.95rem; margin: 0; font-weight: 400;\">\n          Configure temperature and humidity monitoring thresholds\n        </p>\n      </div>\n\n      <!-- Content -->\n      <div style=\"padding: 40px;\">\n\n        <!-- Temperature Range -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 20px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Temperature Range\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Acceptable temperature range for proper food preservation\n            </p>\n          </div>\n\n          <div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 16px;\">\n            <div>\n              <label style=\"color: #6c757d; font-size: 0.875rem; margin-bottom: 8px; display: block;\">Minimum Temperature</label>\n              <v-text-field v-model.number=\"currentConfig.tempMin\" type=\"number\" step=\"0.1\" :min=\"-5\" :max=\"5\"\n                variant=\"outlined\" hide-details=\"auto\" density=\"comfortable\">\n                <template v-slot:append-inner>\n                  <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">¬∞C</span>\n                </template>\n              </v-text-field>\n            </div>\n            <div>\n              <label style=\"color: #6c757d; font-size: 0.875rem; margin-bottom: 8px; display: block;\">Maximum Temperature</label>\n              <v-text-field v-model.number=\"currentConfig.tempMax\" type=\"number\" step=\"0.1\" :min=\"5\" :max=\"15\"\n                variant=\"outlined\" hide-details=\"auto\" density=\"comfortable\">\n                <template v-slot:append-inner>\n                  <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">¬∞C</span>\n                </template>\n              </v-text-field>\n            </div>\n          </div>\n          <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n            Recommended range: 0¬∞C to 8¬∞C\n          </div>\n        </div>\n\n        <!-- Humidity Threshold -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Humidity Threshold\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Maximum humidity level before triggering malfunction alerts\n            </p>\n          </div>\n          <v-text-field v-model.number=\"currentConfig.humidityMax\" type=\"number\" step=\"1\" :min=\"50\" :max=\"95\"\n            variant=\"outlined\" hide-details=\"auto\" style=\"margin-top: 8px;\" density=\"comfortable\">\n            <template v-slot:append-inner>\n              <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">%</span>\n            </template>\n          </v-text-field>\n          <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n            Valid range: 50-95% (recommended: 85%)\n          </div>\n        </div>\n\n        <!-- Alert Settings -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Alert Configuration\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Control when and how often malfunction alerts are sent\n            </p>\n          </div>\n\n          <div style=\"margin-bottom: 20px;\">\n            <v-select v-model=\"currentConfig.enableAlerts\" :items=\"[\n                { title: 'Enabled', value: 'Enabled' },\n                { title: 'Disabled', value: 'Disabled' }\n              ]\" label=\"Malfunction Alerts\" variant=\"outlined\" hide-details=\"auto\" density=\"comfortable\"></v-select>\n          </div>\n\n          <div>\n            <label style=\"color: #6c757d; font-size: 0.875rem; margin-bottom: 8px; display: block;\">Alert Cooldown Period</label>\n            <v-text-field v-model.number=\"currentConfig.alertCooldown\" type=\"number\" :min=\"5\" :max=\"120\"\n              variant=\"outlined\" hide-details=\"auto\" density=\"comfortable\">\n              <template v-slot:append-inner>\n                <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">minutes</span>\n              </template>\n            </v-text-field>\n            <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n              Minimum time between alerts (5-120 minutes)\n            </div>\n          </div>\n        </div>\n\n        <!-- Action Button -->\n        <div style=\"display: flex; justify-content: center; margin-top: 40px;\">\n          <v-btn color=\"#2c3e50\" size=\"large\" style=\"\n              padding: 12px 32px; \n              font-size: 0.95rem; \n              border-radius: 6px; \n              text-transform: none; \n              font-weight: 500;\n              letter-spacing: 0.25px;\n              min-width: 160px;\n            \" @click=\"sendConfig\" :disabled=\"!isConfigValid\" :loading=\"isWaitingResponse\" elevation=\"1\">\n            Apply Settings\n          </v-btn>\n        </div>\n\n        <!-- Status Message -->\n        <div v-if=\"statusMessage\" style=\"margin-top: 24px;\">\n          <div :style=\"{\n            padding: '16px 20px',\n            borderRadius: '6px',\n            backgroundColor: statusError ? '#fff5f5' : '#f0f9ff',\n            border: statusError ? '1px solid #fecaca' : '1px solid #bae6fd',\n            fontSize: '0.875rem',\n            lineHeight: '1.4'\n          }\">\n            <div :style=\"{\n              color: statusError ? '#dc2626' : '#0369a1',\n              fontWeight: '500'\n            }\">\n              {{ statusMessage }}\n            </div>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\n  export default {\n  data() {\n    return {\n      currentConfig: {\n        tempMin: 0.0,\n        tempMax: 8.0,\n        humidityMax: 85.0,\n        enableAlerts: \"Enabled\",\n        alertCooldown: 30\n      },\n      lastValidConfig: {\n        tempMin: 0.0,\n        tempMax: 8.0,\n        humidityMax: 85.0,\n        enableAlerts: \"Enabled\",\n        alertCooldown: 30\n      },\n      statusMessage: \"\",\n      statusError: false,\n      isWaitingResponse: false\n    }\n  },\n  \n  computed: {\n    isConfigValid() {\n      return (\n        this.currentConfig.tempMin >= -5 && \n        this.currentConfig.tempMin <= 5 &&\n        this.currentConfig.tempMax >= 5 && \n        this.currentConfig.tempMax <= 15 &&\n        this.currentConfig.tempMin < this.currentConfig.tempMax &&\n        this.currentConfig.humidityMax >= 50 && \n        this.currentConfig.humidityMax <= 95 &&\n        this.currentConfig.alertCooldown >= 5 && \n        this.currentConfig.alertCooldown <= 120\n      );\n    }\n  },\n  \n  watch: {\n    msg: {\n      handler(newMsg) {\n        if (newMsg && newMsg.topic) {\n          console.log(\"RECEIVED MESSAGE:\", newMsg);\n          \n          if (newMsg.topic === \"config_ack\") {\n            this.handleConfigSuccess(newMsg);\n          } else if (newMsg.topic === \"config_error\") {\n            this.handleConfigError(newMsg);\n          } else if (newMsg.topic === \"config_data\") {\n            this.handleConfigData(newMsg);\n          }\n        }\n      },\n      deep: true,\n      immediate: true\n    }\n  },\n  \n  methods: {\n    sendConfig() {\n      if (!this.isConfigValid) {\n        this.statusMessage = \"Please verify all values are within the specified ranges and that min < max temperature\";\n        this.statusError = true;\n        return;\n      }\n      \n      this.isWaitingResponse = true;\n      const deviceId = this.msg?.deviceId || \"unknown_device\";\n      \n      const message = {\n        type: \"device_config_update\",\n        device_id: deviceId,\n        config: {\n          temp_min_celsius: parseFloat(this.currentConfig.tempMin),\n          temp_max_celsius: parseFloat(this.currentConfig.tempMax),\n          humidity_max_percent: parseFloat(this.currentConfig.humidityMax),\n          enable_malfunction_alerts: (this.currentConfig.enableAlerts === 'Enabled'),\n          alert_cooldown_minutes: parseInt(this.currentConfig.alertCooldown)\n        }\n      };\n      \n      this.send({\n        topic: `Group17/SmartChill/FridgeStatusControl/${deviceId}/config_update`,\n        payload: message\n      });\n      \n      this.statusMessage = \"Applying configuration changes...\";\n      this.statusError = false;\n      \n      setTimeout(() => {\n        if (this.isWaitingResponse) {\n          this.statusMessage = \"Configuration request timed out - please verify device connectivity\";\n          this.statusError = true;\n          this.isWaitingResponse = false;\n        }\n      }, 10000);\n    },\n    \n    handleConfigData(msg) {\n      console.log(\"Loading config data:\", msg.payload);\n      \n      const cfg = msg.payload.config || {};\n      \n      // Popola i campi con i dati reali dal servizio\n      if (cfg.temp_min_celsius !== undefined) {\n        this.currentConfig.tempMin = cfg.temp_min_celsius;\n      }\n      if (cfg.temp_max_celsius !== undefined) {\n        this.currentConfig.tempMax = cfg.temp_max_celsius;\n      }\n      if (cfg.humidity_max_percent !== undefined) {\n        this.currentConfig.humidityMax = cfg.humidity_max_percent;\n      }\n      if (cfg.enable_malfunction_alerts !== undefined) {\n        this.currentConfig.enableAlerts = cfg.enable_malfunction_alerts ? \"Enabled\" : \"Disabled\";\n      }\n      if (cfg.alert_cooldown_minutes !== undefined) {\n        this.currentConfig.alertCooldown = cfg.alert_cooldown_minutes;\n      }\n      \n      // Salva come configurazione valida (per eventuali rollback)\n      this.lastValidConfig = { ...this.currentConfig };\n      \n      this.statusMessage = \"Configuration loaded successfully\";\n      this.statusError = false;\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n      }, 2000);\n    },\n    \n    handleConfigSuccess(msg) {\n      this.isWaitingResponse = false;\n      this.statusMessage = \"Status monitoring configuration has been successfully applied\";\n      this.statusError = false;\n      \n      const cfg = msg.payload.config || {};\n      if (cfg.temp_min_celsius !== undefined) {\n        this.currentConfig.tempMin = cfg.temp_min_celsius;\n      }\n      if (cfg.temp_max_celsius !== undefined) {\n        this.currentConfig.tempMax = cfg.temp_max_celsius;\n      }\n      if (cfg.humidity_max_percent !== undefined) {\n        this.currentConfig.humidityMax = cfg.humidity_max_percent;\n      }\n      if (cfg.enable_malfunction_alerts !== undefined) {\n        this.currentConfig.enableAlerts = cfg.enable_malfunction_alerts ? \"Enabled\" : \"Disabled\";\n      }\n      if (cfg.alert_cooldown_minutes !== undefined) {\n        this.currentConfig.alertCooldown = cfg.alert_cooldown_minutes;\n      }\n      \n      this.lastValidConfig = { ...this.currentConfig };\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n      }, 4000);\n    },\n    \n    handleConfigError(msg) {\n      this.isWaitingResponse = false;\n      const errorMsg = msg.payload.error_message || \"An unexpected error occurred\";\n      this.statusMessage = `Configuration failed: ${errorMsg}`;\n      this.statusError = true;\n      \n      this.currentConfig = { ...this.lastValidConfig };\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n        this.statusError = false;\n      }, 6000);\n    }\n  }\n}\n</script>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 2050,
        "y": 300,
        "wires": [
            [
                "9e4b44d8a8567105"
            ]
        ]
    },
    {
        "id": "4178a5ac06561322",
        "type": "ui-template",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "page": "",
        "ui": "",
        "name": "Food Spoilage",
        "order": 3,
        "width": "4",
        "height": "18",
        "head": "",
        "format": "<template>\n  <div style=\"padding: 60px 40px; max-width: 800px; margin: 0 auto; background: white; min-height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden;\">\n    <div style=\"background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden;\">\n      \n      <!-- Header -->\n      <div style=\"padding: 40px 40px 30px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-bottom: 1px solid #e9ecef;\">\n        <h1 style=\"color: #2c3e50; font-size: 1.75rem; font-weight: 300; margin: 0 0 8px 0; letter-spacing: -0.5px;\">\n          Spoilage Detection Configuration\n        </h1>\n        <p style=\"color: #6c757d; font-size: 0.95rem; margin: 0; font-weight: 400;\">\n          Configure gas sensor thresholds for food spoilage detection\n        </p>\n      </div>\n      \n      <!-- Content -->\n      <div style=\"padding: 40px;\">\n        \n        <!-- Gas Threshold Setting -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Gas Level Threshold\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Gas concentration level that triggers spoilage alerts\n            </p>\n          </div>\n          <v-text-field\n            v-model.number=\"currentConfig.gasThreshold\"\n            type=\"number\"\n            :min=\"100\"\n            :max=\"1000\"\n            step=\"10\"\n            variant=\"outlined\"\n            hide-details=\"auto\"\n            style=\"margin-top: 8px;\"\n            density=\"comfortable\"\n          >\n            <template v-slot:append-inner>\n              <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">PPM</span>\n            </template>\n          </v-text-field>\n          <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n            Valid range: 100-1000 PPM (recommended: 300 PPM)\n          </div>\n        </div>\n        \n        <!-- Alert Behavior -->\n        <div style=\"margin-bottom: 32px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Alert Behavior\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Configure how and when spoilage alerts are triggered\n            </p>\n          </div>\n          \n          <div style=\"margin-bottom: 20px;\">\n            <v-select\n              v-model=\"currentConfig.continuousAlerts\"\n              :items=\"[\n                { title: 'Only on threshold breach', value: 'Disabled' },\n                { title: 'Continuous while above threshold', value: 'Enabled' }\n              ]\"\n              label=\"Alert Frequency\"\n              variant=\"outlined\"\n              hide-details=\"auto\"\n              density=\"comfortable\"\n            ></v-select>\n            <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n              Choose when to send alerts: once when threshold is exceeded, or repeatedly while above threshold\n            </div>\n          </div>\n        </div>\n        \n        <!-- Alert Cooldown -->\n        <div style=\"margin-bottom: 40px;\">\n          <div style=\"margin-bottom: 16px;\">\n            <h3 style=\"color: #495057; font-size: 1.1rem; font-weight: 500; margin: 0 0 4px 0;\">\n              Alert Cooldown Period\n            </h3>\n            <p style=\"color: #6c757d; font-size: 0.875rem; margin: 0; line-height: 1.4;\">\n              Minimum time between consecutive alerts to prevent spam\n            </p>\n          </div>\n          <v-text-field\n            v-model.number=\"currentConfig.alertCooldown\"\n            type=\"number\"\n            :min=\"5\"\n            :max=\"120\"\n            variant=\"outlined\"\n            hide-details=\"auto\"\n            style=\"margin-top: 8px;\"\n            density=\"comfortable\"\n          >\n            <template v-slot:append-inner>\n              <span style=\"color: #6c757d; font-size: 0.875rem; font-weight: 500;\">minutes</span>\n            </template>\n          </v-text-field>\n          <div style=\"color: #6c757d; font-size: 0.75rem; margin-top: 6px;\">\n            Valid range: 5-120 minutes (only applies to continuous alerts)\n          </div>\n        </div>\n        \n        <!-- Action Button -->\n        <div style=\"display: flex; justify-content: center; margin-top: 40px;\">\n          <v-btn\n            color=\"#2c3e50\"\n            size=\"large\"\n            style=\"\n              padding: 12px 32px; \n              font-size: 0.95rem; \n              border-radius: 6px; \n              text-transform: none; \n              font-weight: 500;\n              letter-spacing: 0.25px;\n              min-width: 160px;\n            \"\n            @click=\"sendConfig\"\n            :disabled=\"!isConfigValid\"\n            :loading=\"isWaitingResponse\"\n            elevation=\"1\"\n          >\n            Apply Settings\n          </v-btn>\n        </div>\n        \n        <!-- Status Message -->\n        <div v-if=\"statusMessage\" style=\"margin-top: 24px;\">\n          <div :style=\"{\n            padding: '16px 20px',\n            borderRadius: '6px',\n            backgroundColor: statusError ? '#fff5f5' : '#f0f9ff',\n            border: statusError ? '1px solid #fecaca' : '1px solid #bae6fd',\n            fontSize: '0.875rem',\n            lineHeight: '1.4'\n          }\">\n            <div :style=\"{\n              color: statusError ? '#dc2626' : '#0369a1',\n              fontWeight: '500'\n            }\">\n              {{ statusMessage }}\n            </div>\n          </div>\n        </div>\n        \n      </div>\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      currentConfig: {\n        gasThreshold: 300,\n        continuousAlerts: \"Disabled\",\n        alertCooldown: 15\n      },\n      lastValidConfig: {\n        gasThreshold: 300,\n        continuousAlerts: \"Disabled\",\n        alertCooldown: 15\n      },\n      statusMessage: \"\",\n      statusError: false,\n      isWaitingResponse: false\n    }\n  },\n  \n  computed: {\n    isConfigValid() {\n      return (\n        this.currentConfig.gasThreshold >= 100 && \n        this.currentConfig.gasThreshold <= 1000 &&\n        this.currentConfig.alertCooldown >= 5 && \n        this.currentConfig.alertCooldown <= 120\n      );\n    }\n  },\n  \n  watch: {\n    msg: {\n      handler(newMsg) {\n        if (newMsg && newMsg.topic) {\n          console.log(\"RECEIVED MESSAGE:\", newMsg);\n          \n          if (newMsg.topic === \"config_ack\") {\n            this.handleConfigSuccess(newMsg);\n          } else if (newMsg.topic === \"config_error\") {\n            this.handleConfigError(newMsg);\n          } else if (newMsg.topic === \"config_data\") {\n            this.handleConfigData(newMsg);\n          }\n        }\n      },\n      deep: true,\n      immediate: true\n    }\n  },\n  \n  methods: {\n    sendConfig() {\n      if (!this.isConfigValid) {\n        this.statusMessage = \"Please verify all values are within the specified ranges\";\n        this.statusError = true;\n        return;\n      }\n      \n      this.isWaitingResponse = true;\n      const deviceId = this.msg?.deviceId || \"unknown_device\";\n      \n      const message = {\n        type: \"device_config_update\",\n        device_id: deviceId,\n        config: {\n          gas_threshold_ppm: parseInt(this.currentConfig.gasThreshold),\n          enable_continuous_alerts: (this.currentConfig.continuousAlerts === 'Enabled'),\n          alert_cooldown_minutes: parseInt(this.currentConfig.alertCooldown)\n        }\n      };\n      \n      this.send({\n        topic: `Group17/SmartChill/FoodSpoilageControl/${deviceId}/config_update`,\n        payload: message\n      });\n      \n      this.statusMessage = \"Applying configuration changes...\";\n      this.statusError = false;\n      \n      setTimeout(() => {\n        if (this.isWaitingResponse) {\n          this.statusMessage = \"Configuration request timed out - please verify device connectivity\";\n          this.statusError = true;\n          this.isWaitingResponse = false;\n        }\n      }, 10000);\n    },\n    \n    handleConfigData(msg) {\n      console.log(\"Loading config data:\", msg.payload);\n      \n      const cfg = msg.payload.config || {};\n      \n      // Popola i campi con i dati reali dal servizio\n      if (cfg.gas_threshold_ppm !== undefined) {\n        this.currentConfig.gasThreshold = cfg.gas_threshold_ppm;\n      }\n      if (cfg.enable_continuous_alerts !== undefined) {\n        this.currentConfig.continuousAlerts = cfg.enable_continuous_alerts ? \"Enabled\" : \"Disabled\";\n      }\n      if (cfg.alert_cooldown_minutes !== undefined) {\n        this.currentConfig.alertCooldown = cfg.alert_cooldown_minutes;\n      }\n      \n      // Salva come configurazione valida (per eventuali rollback)\n      this.lastValidConfig = { ...this.currentConfig };\n      \n      this.statusMessage = \"Configuration loaded successfully\";\n      this.statusError = false;\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n      }, 2000);\n    },\n    \n    handleConfigSuccess(msg) {\n      this.isWaitingResponse = false;\n      this.statusMessage = \"Spoilage detection configuration has been successfully applied\";\n      this.statusError = false;\n      \n      const cfg = msg.payload.config || {};\n      if (cfg.gas_threshold_ppm !== undefined) {\n        this.currentConfig.gasThreshold = cfg.gas_threshold_ppm;\n      }\n      if (cfg.enable_continuous_alerts !== undefined) {\n        this.currentConfig.continuousAlerts = cfg.enable_continuous_alerts ? \"Enabled\" : \"Disabled\";\n      }\n      if (cfg.alert_cooldown_minutes !== undefined) {\n        this.currentConfig.alertCooldown = cfg.alert_cooldown_minutes;\n      }\n      \n      this.lastValidConfig = { ...this.currentConfig };\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n      }, 4000);\n    },\n    \n    handleConfigError(msg) {\n      this.isWaitingResponse = false;\n      const errorMsg = msg.payload.error_message || \"An unexpected error occurred\";\n      this.statusMessage = `Configuration failed: ${errorMsg}`;\n      this.statusError = true;\n      \n      this.currentConfig = { ...this.lastValidConfig };\n      \n      setTimeout(() => {\n        this.statusMessage = \"\";\n        this.statusError = false;\n      }, 6000);\n    }\n  }\n}\n</script>",
        "storeOutMessages": true,
        "passthru": true,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 2060,
        "y": 400,
        "wires": [
            [
                "9e4b44d8a8567105"
            ]
        ]
    },
    {
        "id": "4804770e079c9913",
        "type": "ui-text",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "order": 6,
        "width": 0,
        "height": 2,
        "name": "Manage Account",
        "label": "Account Settings",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "style": true,
        "font": "Trebuchet MS,Helvetica,sans-serif",
        "fontSize": "30",
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "x": 1450,
        "y": 620,
        "wires": []
    },
    {
        "id": "6a856f9debce38b1",
        "type": "ui-button",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "name": "",
        "label": "Delete Account",
        "order": 10,
        "width": 2,
        "height": "2",
        "emulateClick": false,
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "custom-btn delete-btn",
        "icon": "account-remove",
        "iconPosition": "left",
        "payload": "delete_account",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "buttonColor": "#c0392b",
        "textColor": "#ffffff",
        "iconColor": "#ffffff",
        "enableClick": true,
        "enablePointerdown": false,
        "pointerdownPayload": "",
        "pointerdownPayloadType": "str",
        "enablePointerup": false,
        "pointerupPayload": "",
        "pointerupPayloadType": "str",
        "x": 1380,
        "y": 700,
        "wires": [
            [
                "9131685c4138523a"
            ]
        ]
    },
    {
        "id": "9131685c4138523a",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Delete",
        "func": "const userSession = global.get('user_session');\n\nif (!userSession || !userSession.isAuthenticated) {\n    node.error(\"No authenticated user session\");\n    return null;\n}\n\nconst userID = (userSession.userName).toLowerCase();\n\n// Prepare DELETE request for user\nmsg.method = \"DELETE\";\nmsg.url = `http://catalog:8001/users/${userID}`;\nmsg.headers = { \"Content-Type\": \"application/json\" };\nmsg.payload = {}; // body not needed\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 700,
        "wires": [
            [
                "2cd6dffc9d5c1d21"
            ]
        ]
    },
    {
        "id": "529aa0e8d1f0c85c",
        "type": "ui-button",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "name": "Disassociate Fridge",
        "label": "Eliminate Fridge from Devices",
        "order": 8,
        "width": 2,
        "height": "2",
        "emulateClick": false,
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "custom-btn fridge-btn",
        "icon": "fridge-off",
        "iconPosition": "left",
        "payload": "disassociate_fridge",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "buttonColor": "#2c3e50",
        "textColor": "#ffffff",
        "iconColor": "#ffffff",
        "enableClick": true,
        "enablePointerdown": false,
        "pointerdownPayload": "",
        "pointerdownPayloadType": "str",
        "enablePointerup": false,
        "pointerupPayload": "",
        "pointerupPayloadType": "str",
        "x": 1390,
        "y": 780,
        "wires": [
            [
                "a1a0eb627432838d"
            ]
        ]
    },
    {
        "id": "a1a0eb627432838d",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Disassociate",
        "func": "const userSession = global.get('user_session');\n\nif (!userSession || !userSession.isAuthenticated) {\n    node.error(\"No authenticated user session\");\n    return null;\n}\n\nif (!userSession.deviceId) {\n    node.error(\"No device associated with session\");\n    return null;\n}\n\n// Prepare POST request to unassign device\nmsg.method = \"POST\";\nmsg.url = `http://catalog:8001/devices/${userSession.deviceId}/unassign`;\nmsg.headers = { \"Content-Type\": \"application/json\" };\nmsg.payload = {}; // empty body\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1610,
        "y": 780,
        "wires": [
            [
                "2cd6dffc9d5c1d21"
            ]
        ]
    },
    {
        "id": "2cd6dffc9d5c1d21",
        "type": "http request",
        "z": "dashboard_tab",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 1810,
        "y": 740,
        "wires": [
            [
                "933ed2fc95f72e3f",
                "be1755fa5d9d2f75"
            ]
        ]
    },
    {
        "id": "933ed2fc95f72e3f",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Handle Response",
        "func": "// Output 1 = notification (always)\n// Output 2 = redirect (only if unassign success)\n\nif (msg.payload?.message && (msg.payload.message.includes(\"unassigned successfully\") || msg.payload.message.includes(\"deleted successfully\"))) {\n    // Success case\n    const notification = {\n        payload: msg.payload.message,\n        ui_update: {\n            color: \"green\",\n            position: \"top center\",\n            displayTime: 3,\n            showCountdown: true,\n            allowDismiss: false\n        }\n    };\n\n    const redirect = {\n        payload: \"SmartChill Login\"   // ui_control will open Login page\n    };\n\n    return [notification, redirect];\n\n} else if (msg.payload?.already_unassigned) {\n    // Special case: device was already unassigned\n    const notification = {\n        payload: \"Device already unassigned.\",\n        ui_update: {\n            color: \"orange\",\n            position: \"top center\",\n            displayTime: 3,\n            showCountdown: true,\n            allowDismiss: true\n        }\n    };\n\n    return [notification, null];  // show notification, no redirect\n\n} else {\n    // Error case\n    const notification = {\n        payload: msg.payload?.message || \"Operation failed\",\n        ui_update: {\n            color: \"red\",\n            position: \"top center\",\n            displayTime: 3,\n            showCountdown: true,\n            allowDismiss: true\n        }\n    };\n\n    return [notification, null];  // show error only\n}\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2030,
        "y": 740,
        "wires": [
            [
                "0c2f35080aa13935"
            ],
            [
                "64234458030608a7"
            ]
        ],
        "outputLabels": [
            "Success",
            "Error"
        ]
    },
    {
        "id": "0c2f35080aa13935",
        "type": "ui-notification",
        "z": "dashboard_tab",
        "ui": "ui_base",
        "position": "top right",
        "colorDefault": true,
        "color": "#000000",
        "displayTime": "3",
        "showCountdown": true,
        "outputs": 1,
        "allowDismiss": true,
        "dismissText": "Close",
        "allowConfirm": false,
        "confirmText": "Confirm",
        "raw": false,
        "className": "",
        "name": "",
        "x": 2240,
        "y": 700,
        "wires": [
            []
        ]
    },
    {
        "id": "861e899afddac4b7",
        "type": "ui-control",
        "z": "dashboard_tab",
        "name": "Redirect Page",
        "ui": "ui_base",
        "events": "change",
        "x": 2460,
        "y": 780,
        "wires": [
            []
        ]
    },
    {
        "id": "be1755fa5d9d2f75",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 11",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 2000,
        "y": 820,
        "wires": []
    },
    {
        "id": "64234458030608a7",
        "type": "delay",
        "z": "dashboard_tab",
        "name": "",
        "pauseType": "delay",
        "timeout": "3",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2240,
        "y": 780,
        "wires": [
            [
                "861e899afddac4b7"
            ]
        ]
    },
    {
        "id": "99f94f7aaf8f8360",
        "type": "ui-text",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "order": 2,
        "width": 0,
        "height": 2,
        "name": "Service Settings",
        "label": "Service Settings",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "style": true,
        "font": "Trebuchet MS,Helvetica,sans-serif",
        "fontSize": "30",
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "x": 1280,
        "y": 280,
        "wires": []
    },
    {
        "id": "ac851234d6e1b26f",
        "type": "ui-text",
        "z": "dashboard_tab",
        "group": "hero_group",
        "order": 4,
        "width": 0,
        "height": 2,
        "name": "Analysis Overview",
        "label": "Analysis Overview",
        "format": "{{msg.payload}}",
        "layout": "col-center",
        "style": true,
        "font": "Copperplate,Copperplate Gothic Light,fantasy",
        "fontSize": "28",
        "color": "#717171",
        "wrapText": false,
        "className": "",
        "x": 694.8956909179688,
        "y": 362.9304504394531,
        "wires": []
    },
    {
        "id": "2214ed386b03a169",
        "type": "ui-button",
        "z": "dashboard_tab",
        "group": "58fd4ecb3e5a8e5e",
        "name": "",
        "label": "",
        "order": 1,
        "width": "1",
        "height": "1",
        "emulateClick": false,
        "tooltip": "",
        "color": "",
        "bgcolor": "",
        "className": "",
        "icon": "chevron-left",
        "iconPosition": "left",
        "payload": "SmartChill Dashboard",
        "payloadType": "str",
        "topic": "topic",
        "topicType": "msg",
        "buttonColor": "#7f8c8d",
        "textColor": "",
        "iconColor": "",
        "enableClick": true,
        "enablePointerdown": false,
        "pointerdownPayload": "",
        "pointerdownPayloadType": "str",
        "enablePointerup": false,
        "pointerupPayload": "",
        "pointerupPayloadType": "str",
        "x": 1350,
        "y": 540,
        "wires": [
            [
                "ef7bca727257cb7d"
            ]
        ]
    },
    {
        "id": "ef7bca727257cb7d",
        "type": "ui-control",
        "z": "dashboard_tab",
        "name": "Previous Page",
        "ui": "ui_base",
        "events": "all",
        "x": 1540,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "100110691354da8c",
        "type": "function",
        "z": "dashboard_tab",
        "name": "Prepare Config Request",
        "func": "// Function Node: Prepare Config Request for ALL services\nconst session = global.get('user_session');\nconst deviceId = session?.deviceId || \"unknown_device\";\n\nconst services = [\"TimerUsageControl\", \"FridgeStatusControl\", \"FoodSpoilageControl\"];\n\nconst message = {\n    type: \"config_get\",\n    device_id: deviceId\n};\n\n// Create array of messages for all 3 services\nconst outputs = services.map(service => ({\n    topic: `Group17/SmartChill/${service}/${deviceId}/config_update`,\n    payload: message,\n    service: service\n}));\n\nreturn outputs;",
        "outputs": 3,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1250,
        "y": 180,
        "wires": [
            [
                "f697584c0b219222",
                "6365f11c34accd25"
            ],
            [
                "f42c97c71cc159f3",
                "6365f11c34accd25"
            ],
            [
                "06c45fd562e267af",
                "6365f11c34accd25"
            ]
        ]
    },
    {
        "id": "f697584c0b219222",
        "type": "mqtt out",
        "z": "dashboard_tab",
        "name": "Get Config Service 1",
        "topic": "",
        "qos": "2",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "cae7e64b62c3d84e",
        "x": 1540,
        "y": 140,
        "wires": []
    },
    {
        "id": "dd2a6cb5470b6f0d",
        "type": "mqtt in",
        "z": "dashboard_tab",
        "name": "Retireve Configs",
        "topic": "Group17/SmartChill/+/+/config_data",
        "qos": "2",
        "datatype": "json",
        "broker": "cae7e64b62c3d84e",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 1480,
        "y": 280,
        "wires": [
            [
                "c002d98e55aeb287"
            ]
        ]
    },
    {
        "id": "f42c97c71cc159f3",
        "type": "mqtt out",
        "z": "dashboard_tab",
        "name": "Get Config Service 2",
        "topic": "",
        "qos": "2",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "cae7e64b62c3d84e",
        "x": 1540,
        "y": 180,
        "wires": []
    },
    {
        "id": "06c45fd562e267af",
        "type": "mqtt out",
        "z": "dashboard_tab",
        "name": "Get Config Service 3",
        "topic": "",
        "qos": "2",
        "retain": "false",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "cae7e64b62c3d84e",
        "x": 1540,
        "y": 220,
        "wires": []
    },
    {
        "id": "6365f11c34accd25",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 13",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1740,
        "y": 180,
        "wires": []
    },
    {
        "id": "c9cabd05d3aa442c",
        "type": "debug",
        "z": "dashboard_tab",
        "name": "debug 16",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 960,
        "y": 440,
        "wires": []
    },
    {
        "id": "c649be102a5dffe5",
        "type": "link in",
        "z": "5dc8affbd505959b",
        "name": "To Admin Dashboard",
        "links": [
            "d56205248b8bf587"
        ],
        "x": 135,
        "y": 400,
        "wires": [
            [
                "71464ffe65fd0575",
                "b8dd8278782e8f27"
            ]
        ]
    },
    {
        "id": "1031191dc2280384",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Get Devices",
        "func": "// Prepara chiamata HTTP al catalog\nmsg.method = 'GET';\nmsg.url = 'http://catalog:8001/devices';\nmsg.headers = { 'Content-Type': 'application/json' };\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 260,
        "wires": [
            [
                "5c8bb20f3efea6b7"
            ]
        ]
    },
    {
        "id": "5c8bb20f3efea6b7",
        "type": "http request",
        "z": "5dc8affbd505959b",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 260,
        "wires": [
            [
                "c016fa6a27292ae6"
            ]
        ]
    },
    {
        "id": "c016fa6a27292ae6",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Handle Data",
        "func": "if (msg.statusCode === 200) {\n    return {\n        devices: msg.payload,\n        timestamp: new Date().toISOString()\n    };\n} else {\n    return {\n        error: `Failed to load devices: ${msg.statusCode}`\n    };\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 260,
        "wires": [
            [
                "71464ffe65fd0575"
            ]
        ]
    },
    {
        "id": "71464ffe65fd0575",
        "type": "ui-template",
        "z": "5dc8affbd505959b",
        "group": "9c3a47613a75c26f",
        "page": "",
        "ui": "",
        "name": "Devices Overview",
        "order": 1,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <div style=\"padding: 40px; background: #f9f8f6; min-height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif;\">\n    <div style=\"max-width: 1200px; margin: 0 auto;\">\n\n      <!-- Header -->\n      <div style=\"margin-bottom: 32px;\">\n        <h1 style=\"color: #3e3e32; font-size: 2rem; font-weight: 400; margin: 0 0 8px 0;\">\n          Device Management\n        </h1>\n        <p style=\"color: #7a7a6f; font-size: 1rem; margin: 0;\">\n          Manage all SmartChill devices in the system\n        </p>\n      </div>\n\n      <!-- Loading -->\n      <div v-if=\"isLoading\" style=\"text-align: center; padding: 60px;\">\n        <div\n          style=\"width: 40px; height: 40px; border: 3px solid #e6e3da; border-top: 3px solid #b8a97e; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;\">\n        </div>\n        <p style=\"color: #7a7a6f;\">Loading devices...</p>\n      </div>\n\n      <!-- Error -->\n      <div v-else-if=\"hasError\" style=\"text-align: center; padding: 60px;\">\n        <div style=\"font-size: 3em; margin-bottom: 16px;\">‚ö†Ô∏è</div>\n        <h3 style=\"color: #3e3e32;\">Failed to load devices</h3>\n        <p style=\"color: #7a7a6f; margin-bottom: 20px;\">{{ errorMessage }}</p>\n        <button @click=\"loadDevices\" style=\"background: #b8a97e; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;\">\n          Retry\n        </button>\n      </div>\n\n      <!-- Device Grid -->\n      <div v-else style=\"display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 24px;\">\n\n        <!-- Device Card with Flip -->\n        <div v-for=\"device in devices\" :key=\"device.deviceID\" class=\"card-container\">\n          <div class=\"card\" :class=\"{ flipped: flippedDevice === device.deviceID }\">\n\n            <!-- Front Side -->\n            <div class=\"card-front\">\n              <div class=\"card-header\">\n                <div style=\"display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;\">\n                  <div>\n                    <h3 class=\"card-title\">\n                      {{ device.user_device_name || device.deviceID }}\n                    </h3>\n                    <p class=\"card-subtitle\">{{ device.model }}</p>\n                  </div>\n                  <div class=\"status-badge\" :style=\"{\n                    backgroundColor: getStatusColor(device.status).bg,\n                    color: getStatusColor(device.status).text\n                  }\">\n                    {{ device.status }}\n                  </div>\n                </div>\n                <div style=\"font-size: 0.8rem; color: #4e4e40; background: rgba(255,255,255,0.6); padding: 2px 6px; border-radius: 8px;\">\n                  {{ device.deviceID }}\n                </div>\n              </div>\n\n              <div class=\"card-body\">\n                <div class=\"info-grid\">\n                  <div>\n                    <strong>MAC Address:</strong><br>\n                    <span class=\"muted\">{{ device.mac_address }}</span>\n                  </div>\n                  <div>\n                    <strong>Firmware:</strong><br>\n                    <span class=\"muted\">v{{ device.firmware_version }}</span>\n                  </div>\n                </div>\n\n                <div v-if=\"device.user_assigned\" class=\"assigned\">\n                  <div>\n                    <strong>Assigned to:</strong> {{ device.assigned_user }}<br>\n                    <span class=\"muted\">Since: {{ device.assignment_time }}</span>\n                  </div>\n                </div>\n                <div v-else class=\"unassigned\">\n                  <strong>Unassigned device</strong>\n                </div>\n\n                <div style=\"margin-bottom: 16px;\">\n                  <strong>Sensors:</strong>\n                  <div style=\"display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px;\">\n                    <span v-for=\"sensor in device.sensors\" :key=\"sensor\" class=\"sensor-badge\">\n                      {{ sensor }}\n                    </span>\n                  </div>\n                </div>\n\n                <div class=\"timestamps\">\n                  <div>Registered: {{ device.registration_time }}</div>\n                  <div>Last sync: {{ device.last_sync }}</div>\n                </div>\n\n                <div class=\"actions\">\n                  <button @click=\"flipCard(device.deviceID)\">View Details</button>\n                  <button class=\"danger\" @click=\"confirmDelete(device)\">Delete</button>\n                </div>\n              </div>\n            </div>\n\n            <!-- Back Side -->\n            <div class=\"card-back\">\n              <h3 style=\"margin-bottom: 12px;\">Device Details</h3>\n              <div class=\"details\">\n                <p><strong>Device ID:</strong> {{ device.deviceID }}</p>\n                <p><strong>Model:</strong> {{ device.model }}</p>\n                <p><strong>MAC:</strong> {{ device.mac_address }}</p>\n                <p><strong>Firmware:</strong> v{{ device.firmware_version }}</p>\n\n                <p><strong>MQTT Broker:</strong> {{ device.mqtt_config.broker }}</p>\n                <p><strong>Topic Template:</strong> {{ device.mqtt_config.topicTemplate }}</p>\n\n                <p><strong>MQTT Topics:</strong></p>\n                <ul>\n                  <li v-for=\"topic in device.mqtt_topics\" :key=\"topic\" class=\"muted\">{{ topic }}</li>\n                </ul>\n              </div>\n\n              <div class=\"actions\">\n                <button @click=\"flipCard(null)\">Back</button>\n              </div>\n            </div>\n\n          </div>\n        </div>\n      </div>\n\n      <!-- Empty -->\n      <div v-if=\"!isLoading && !hasError && devices.length === 0\" style=\"text-align: center; padding: 60px;\">\n        <div style=\"font-size: 3em; margin-bottom: 16px;\">üì±</div>\n        <h3 style=\"color: #3e3e32;\">No devices found</h3>\n        <p style=\"color: #7a7a6f;\">No SmartChill devices are currently registered in the system.</p>\n      </div>\n\n      <!-- Delete Confirmation Modal -->\n      <div v-if=\"showDeleteModal\" class=\"modal-overlay\">\n        <div class=\"modal\">\n          <h3>Confirm Device Deletion</h3>\n          <p>\n            Are you sure you want to delete\n            <strong>{{ deviceToDelete?.user_device_name || deviceToDelete?.deviceID }}</strong>?\n            This action cannot be undone.\n          </p>\n          <div class=\"modal-actions\">\n            <button @click=\"cancelDelete\">Cancel</button>\n            <button class=\"danger\" @click=\"deleteDevice\">Delete Device</button>\n          </div>\n        </div>\n      </div>\n\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      devices: [],\n      isLoading: true,\n      hasError: false,\n      errorMessage: '',\n      showDeleteModal: false,\n      deviceToDelete: null,\n      flippedDevice: null\n    }\n  },\n\n  mounted() {\n    this.loadDevices();\n  },\n\n  watch: {\n    msg: {\n      handler(newMsg) {\n        if (newMsg && newMsg.devices) {\n          this.isLoading = false;\n          this.hasError = false;\n          this.devices = newMsg.devices;\n        } else if (newMsg && newMsg.error) {\n          this.isLoading = false;\n          this.hasError = true;\n          this.errorMessage = newMsg.error;\n        } else if (newMsg && newMsg.deleted) {\n          this.devices = this.devices.filter(d => d.deviceID !== newMsg.deleted.deviceID);\n        } else if (newMsg && newMsg.payload) {\n          // aggiornamento payload dettagliato\n          const updated = this.devices.map(d =>\n            d.deviceID === newMsg.payload.deviceID ? newMsg.payload : d\n          );\n          this.devices = updated;\n        }\n      },\n      immediate: true,\n      deep: true\n    }\n  },\n\n  methods: {\n    loadDevices() {\n      this.isLoading = true;\n      this.hasError = false;\n      this.send({ action: 'load_devices' });\n    },\n\n    getStatusColor(status) {\n      const colors = {\n        registered: { bg: '#e8f5e8', text: '#2e7d32' },\n        active: { bg: '#e8f5e8', text: '#2e7d32' },\n        inactive: { bg: '#fff3e0', text: '#f57c00' },\n        error: { bg: '#ffebee', text: '#d32f2f' }\n      };\n      return colors[status] || { bg: '#f5f5f5', text: '#666' };\n    },\n\n    flipCard(deviceID) {\n      this.flippedDevice = this.flippedDevice === deviceID ? null : deviceID;\n    },\n\n    confirmDelete(device) {\n      this.deviceToDelete = device;\n      this.showDeleteModal = true;\n    },\n\n    cancelDelete() {\n      this.showDeleteModal = false;\n      this.deviceToDelete = null;\n    },\n\n    deleteDevice() {\n      if (this.deviceToDelete) {\n        this.send({\n          action: 'delete_device',\n          deviceID: this.deviceToDelete.deviceID\n        });\n        this.showDeleteModal = false;\n        this.deviceToDelete = null;\n      }\n    }\n  }\n}\n</script>\n\n<style>\n@keyframes spin {\n0% { transform: rotate(0deg); }\n100% { transform: rotate(360deg); }\n}\n\n/* Card Flip */\n.card-container {\nperspective: 1000px;\n}\n.card {\nposition: relative;\nwidth: 100%;\nheight: 100%;\ntransform-style: preserve-3d;\ntransition: transform 0.6s;\nborder-radius: 12px;\nbox-shadow: 0 2px 8px rgba(0,0,0,0.05);\n}\n.card.flipped {\ntransform: rotateY(180deg);\n}\n.card-front,\n.card-back {\nposition: absolute;\nwidth: 100%;\nbackface-visibility: hidden;\nborder-radius: 12px;\nbackground: #ffffff; /* beige card */\noverflow: hidden;\n}\n.card-front {\nz-index: 2;\n}\n.card-back {\ntransform: rotateY(180deg);\npadding: 20px;\n}\n\n/* Header */\n.card-header {\nbackground: linear-gradient(135deg, #edece4 0%, #e3e1d7 100%);\npadding: 20px;\nborder-bottom: 1px solid #dcdacb;\n}\n.card-title {\nmargin: 0;\ncolor: #2c3e50; /* blu scuro elegante */\nfont-size: 1.2rem;\nfont-weight: 600;\n}\n.card-subtitle {\nmargin: 2px 0 0 0;\ncolor: #6c757d; /* grigio secondario */\nfont-size: 0.85rem;\n}\n.status-badge {\npadding: 4px 8px;\nborder-radius: 12px;\nfont-size: 0.75rem;\nfont-weight: bold;\n}\n\n/* Body */\n.card-body {\npadding: 20px;\n}\n.info-grid {\ndisplay: grid;\ngrid-template-columns: 1fr 1fr;\ngap: 12px;\nfont-size: 0.85rem;\nmargin-bottom: 16px;\n}\n.muted {\ncolor: #6c757d; /* testo secondario */\nfont-family: monospace;\n}\n.assigned {\nmargin-bottom: 16px;\npadding: 12px;\nbackground: rgba(184, 169, 126, 0.1);\nborder-left: 3px solid #a18f64;\nborder-radius: 8px;\nfont-size: 0.85rem;\n}\n.unassigned {\nmargin-bottom: 16px;\npadding: 12px;\nbackground: rgba(255, 200, 120, 0.1);\nborder-left: 3px solid #d49c3d;\nborder-radius: 8px;\nfont-size: 0.85rem;\ncolor: #a16800;\n}\n.sensor-badge {\nbackground: rgba(184, 169, 126, 0.15);\ncolor: #6e5b32;\npadding: 2px 6px;\nborder-radius: 10px;\nfont-size: 0.75rem;\n}\n.timestamps {\nmargin-bottom: 20px;\nfont-size: 0.8rem;\ncolor: #6c757d;\nline-height: 1.4;\n}\n.actions {\ndisplay: flex;\ngap: 8px;\n}\n.actions button {\nflex: 1;\nbackground: #1e3a5f; /* blu elegante */\ncolor: white;\nborder: none;\npadding: 8px 12px;\nborder-radius: 6px;\ncursor: pointer;\nfont-size: 0.85rem;\ntransition: background 0.2s;\n}\n.actions button:hover {\nbackground: #2d5986; /* blu hover */\n}\n.actions button.danger {\nbackground: #c94c4c; /* rosso delete */\n}\n.actions button.danger:hover {\nbackground: #a83e3e;\n}\n\n/* Back side */\n.details {\nfont-size: 0.85rem;\ncolor: #2c3e50; /* testo scuro */\nline-height: 1.4;\n}\n.details ul {\npadding-left: 18px;\nmargin: 6px 0;\n}\n.details li {\nfont-size: 0.8rem;\ncolor: #6c757d; /* grigio */\n}\n\n/* Modal */\n.modal-overlay {\nposition: fixed;\ntop: 0; left: 0; right: 0; bottom: 0;\nbackground: rgba(0,0,0,0.4);\ndisplay: flex;\nalign-items: center;\njustify-content: center;\nz-index: 1000;\n}\n.modal {\nbackground: #ffffff; /* bianco pulito */\nborder-radius: 12px;\npadding: 24px;\nmax-width: 400px;\nmargin: 20px;\nbox-shadow: 0 4px 12px rgba(0,0,0,0.15);\n}\n.modal h3 {\nmargin: 0 0 12px 0;\ncolor: #2c3e50;\n}\n.modal p {\ncolor: #6c757d;\nmargin-bottom: 20px;\nline-height: 1.4;\n}\n.modal-actions {\ndisplay: flex;\ngap: 12px;\njustify-content: flex-end;\n}\n.modal-actions button {\nbackground: #e6e3da;\ncolor: #2c3e50;\nborder: none;\npadding: 10px 16px;\nborder-radius: 6px;\ncursor: pointer;\n}\n.modal-actions button.danger {\nbackground: #c94c4c;\ncolor: white;\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 370,
        "y": 300,
        "wires": [
            [
                "1249aacd9eaffddb"
            ]
        ]
    },
    {
        "id": "1249aacd9eaffddb",
        "type": "switch",
        "z": "5dc8affbd505959b",
        "name": "",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "load_devices",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "delete_device",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 550,
        "y": 300,
        "wires": [
            [
                "1031191dc2280384"
            ],
            [
                "1b4bd994966190ad"
            ]
        ]
    },
    {
        "id": "1b4bd994966190ad",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Delete Devices",
        "func": "// Prepara chiamata HTTP al catalog\nmsg.method = 'DELETE';\nmsg.url = `http://catalog:8001/devices/${msg.deviceID}`;\nmsg.headers = { 'Content-Type': 'application/json' };\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 340,
        "wires": [
            [
                "62f76955212a80cd"
            ]
        ]
    },
    {
        "id": "62f76955212a80cd",
        "type": "http request",
        "z": "5dc8affbd505959b",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 340,
        "wires": [
            [
                "fca478d531a33106"
            ]
        ]
    },
    {
        "id": "fca478d531a33106",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Handle Data",
        "func": "if (msg.statusCode === 200) {\n    return {\n        deleted: { deviceID: msg.payload.deviceID },\n        message: 'Device deleted successfully'\n    };\n} else {\n    return {\n        error: `Delete failed: ${msg.statusCode}`\n    };\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 340,
        "wires": [
            [
                "71464ffe65fd0575"
            ]
        ]
    },
    {
        "id": "188eb6e2e6e2f35e",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Get Services",
        "func": "// Prepara chiamata HTTP al catalog\nmsg.method = 'GET';\nmsg.url = 'http://catalog:8001/services';\nmsg.headers = { 'Content-Type': 'application/json' };\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 440,
        "wires": [
            [
                "508fa7ee69be73dc"
            ]
        ]
    },
    {
        "id": "508fa7ee69be73dc",
        "type": "http request",
        "z": "5dc8affbd505959b",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 440,
        "wires": [
            [
                "2ea2f8051b2015a2",
                "a6e4d4577341e792"
            ]
        ]
    },
    {
        "id": "2ea2f8051b2015a2",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Handle Data",
        "func": "if (msg.statusCode === 200) {\n    return {\n        services: msg.payload,\n        timestamp: new Date().toISOString()\n    };\n} else {\n    return {\n        error: `Failed to load services: ${msg.statusCode}`\n    };\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1110,
        "y": 440,
        "wires": [
            [
                "b8dd8278782e8f27",
                "a6e4d4577341e792"
            ]
        ]
    },
    {
        "id": "b8dd8278782e8f27",
        "type": "ui-template",
        "z": "5dc8affbd505959b",
        "group": "cd8cdd43a349e446",
        "page": "",
        "ui": "",
        "name": "Services Overview",
        "order": 1,
        "width": "0",
        "height": "0",
        "head": "",
        "format": "<template>\n  <div style=\"padding: 40px; background: #ffffff; min-height: 100vh; font-family: 'Segoe UI', system-ui, sans-serif;\">\n    <div style=\"max-width: 1200px; margin: 0 auto;\">\n\n      <!-- Header -->\n      <div style=\"margin-bottom: 32px;\">\n        <h1 style=\"color: #2c3e50; font-size: 2rem; font-weight: 400; margin: 0 0 8px 0;\">\n          Service Management\n        </h1>\n        <p style=\"color: #6c757d; font-size: 1rem; margin: 0;\">\n          Manage all SmartChill services in the system\n        </p>\n      </div>\n\n      <!-- Loading -->\n      <div v-if=\"isLoading\" style=\"text-align: center; padding: 60px;\">\n        <div\n          style=\"width: 40px; height: 40px; border: 3px solid #e6e3da; border-top: 3px solid #1e3a5f; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;\">\n        </div>\n        <p style=\"color: #6c757d;\">Loading services...</p>\n      </div>\n\n      <!-- Error -->\n      <div v-else-if=\"hasError\" style=\"text-align: center; padding: 60px;\">\n        <div style=\"font-size: 3em; margin-bottom: 16px;\">‚ö†Ô∏è</div>\n        <h3 style=\"color: #2c3e50;\">Failed to load services</h3>\n        <p style=\"color: #6c757d; margin-bottom: 20px;\">{{ errorMessage }}</p>\n        <button @click=\"loadServices\" style=\"background: #1e3a5f; color: #fff; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;\">\n          Retry\n        </button>\n      </div>\n\n      <!-- Services Scrollable Row -->\n      <div v-else class=\"services-scroll\">\n        <div v-for=\"service in services\" :key=\"service.serviceID\" class=\"service-card-container\">\n          <div class=\"service-card\" :class=\"{ flipped: flippedService === service.serviceID }\">\n\n            <!-- Front Side -->\n            <div class=\"service-card-front\">\n              <div class=\"card-header\">\n                <div style=\"display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;\">\n                  <div>\n                    <h3 class=\"card-title\">{{ service.name }}</h3>\n                    <p class=\"card-subtitle\">{{ service.type }}</p>\n                  </div>\n                  <div class=\"status-badge\" :style=\"{\n                    backgroundColor: getStatusColor(service.status).bg,\n                    color: getStatusColor(service.status).text\n                  }\">\n                    {{ service.status }}\n                  </div>\n                </div>\n                <div style=\"font-size: 0.8rem; color: #6c757d; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 8px;\">\n                  {{ service.serviceID }}\n                </div>\n              </div>\n\n              <div class=\"card-body\">\n                <div class=\"info-grid\">\n                  <div>\n                    <strong>Version:</strong><br>\n                    <span class=\"muted\">{{ service.version }}</span>\n                  </div>\n                  <div>\n                    <strong>Last Update:</strong><br>\n                    <span class=\"muted\">{{ service.lastUpdate }}</span>\n                  </div>\n                </div>\n\n                <div class=\"timestamps\">\n                  <div>{{ service.description }}</div>\n                </div>\n\n                <div class=\"actions\">\n                  <button @click=\"flipCard(service.serviceID)\">View Details</button>\n                  <button class=\"danger\" @click=\"confirmDelete(service)\">Delete</button>\n                </div>\n              </div>\n            </div>\n\n            <!-- Back Side -->\n            <div class=\"service-card-back\">\n              <h3 style=\"margin-bottom: 12px;\">Service Details</h3>\n              <div class=\"details\">\n                <p><strong>Service ID:</strong> {{ service.serviceID }}</p>\n                <p><strong>Name:</strong> {{ service.name }}</p>\n                <p><strong>Type:</strong> {{ service.type }}</p>\n                <p><strong>Version:</strong> {{ service.version }}</p>\n                <p><strong>Last Update:</strong> {{ service.lastUpdate }}</p>\n\n                <p><strong>Endpoints:</strong></p>\n                <ul>\n                  <li v-for=\"ep in service.endpoints\" :key=\"ep\" class=\"muted\">{{ ep }}</li>\n                </ul>\n              </div>\n\n              <div class=\"actions\">\n                <button @click=\"flipCard(null)\">Back</button>\n              </div>\n            </div>\n\n          </div>\n        </div>\n      </div>\n\n      <!-- Empty -->\n      <div v-if=\"!isLoading && !hasError && services.length === 0\" style=\"text-align: center; padding: 60px;\">\n        <div style=\"font-size: 3em; margin-bottom: 16px;\">üõ†Ô∏è</div>\n        <h3 style=\"color: #2c3e50;\">No services found</h3>\n        <p style=\"color: #6c757d;\">No SmartChill services are currently registered in the system.</p>\n      </div>\n\n      <!-- Delete Confirmation Modal -->\n      <div v-if=\"showDeleteModal\" class=\"modal-overlay\">\n        <div class=\"modal\">\n          <h3>Confirm Service Deletion</h3>\n          <p>\n            Are you sure you want to delete\n            <strong>{{ serviceToDelete?.name || serviceToDelete?.serviceID }}</strong>?\n            This action cannot be undone.\n          </p>\n          <div class=\"modal-actions\">\n            <button @click=\"cancelDelete\">Cancel</button>\n            <button class=\"danger\" @click=\"deleteService\">Delete Service</button>\n          </div>\n        </div>\n      </div>\n\n    </div>\n  </div>\n</template>\n\n<script>\nexport default {\n  data() {\n    return {\n      services: [],\n      isLoading: true,\n      hasError: false,\n      errorMessage: '',\n      showDeleteModal: false,\n      serviceToDelete: null,\n      flippedService: null\n    }\n  },\n\n  mounted() {\n    this.loadServices();\n  },\n\n  watch: {\n    msg: {\n      handler(newMsg) {\n        if (newMsg && newMsg.services) {\n          this.isLoading = false;\n          this.hasError = false;\n          this.services = newMsg.services;\n        } else if (newMsg && newMsg.error) {\n          this.isLoading = false;\n          this.hasError = true;\n          this.errorMessage = newMsg.error;\n        } else if (newMsg && newMsg.deleted) {\n          this.services = this.services.filter(s => s.serviceID !== newMsg.deleted.serviceID);\n        } else if (newMsg && newMsg.payload) {\n          const updated = this.services.map(s =>\n            s.serviceID === newMsg.payload.serviceID ? newMsg.payload : s\n          );\n          this.services = updated;\n        }\n      },\n      immediate: true,\n      deep: true\n    }\n  },\n\n  methods: {\n    loadServices() {\n      this.isLoading = true;\n      this.hasError = false;\n      this.send({ action: 'load_services' });\n    },\n\n    getStatusColor(status) {\n      const colors = {\n        active: { bg: '#e8f5e8', text: '#2e7d32' },\n        inactive: { bg: '#fff3e0', text: '#f57c00' },\n        error: { bg: '#ffebee', text: '#d32f2f' }\n      };\n      return colors[status] || { bg: '#f5f5f5', text: '#666' };\n    },\n\n    flipCard(serviceID) {\n      this.flippedService = this.flippedService === serviceID ? null : serviceID;\n    },\n\n    confirmDelete(service) {\n      this.serviceToDelete = service;\n      this.showDeleteModal = true;\n    },\n\n    cancelDelete() {\n      this.showDeleteModal = false;\n      this.serviceToDelete = null;\n    },\n\n    deleteService() {\n      if (this.serviceToDelete) {\n        this.send({\n          action: 'delete_service',\n          serviceID: this.serviceToDelete.serviceID\n        });\n        this.showDeleteModal = false;\n        this.serviceToDelete = null;\n      }\n    }\n  }\n}\n</script>\n\n<style>\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n\n/* Scroll Row per i servizi */\n.services-scroll {\n  display: flex;\n  gap: 24px;\n  overflow-x: auto;\n  padding: 60px 0;\n  min-height: 600px;\n  max-width: 2600px; /* üëà invece di 1200px */\n  margin: 0 auto;\n}\n\n.services-scroll::-webkit-scrollbar {\n  height: 8px;\n}\n.services-scroll::-webkit-scrollbar-thumb {\n  background: #ccc;\n  border-radius: 4px;\n}\n\n/* Contenitore card servizio */\n.service-card-container {\n  perspective: 1500px;\n  flex: 0 0 520px;\n  min-height: 320px;\n}\n\n/* Card flip */\n.service-card {\n  position: relative;\n  width: 100%;\n  height: 100%;\n  transform-style: preserve-3d;\n  transition: transform 0.6s;\n  border-radius: 12px;\n  box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n}\n.service-card.flipped {\n  transform: rotateY(180deg);\n}\n\n/* Lati della card */\n.service-card-front,\n.service-card-back {\n  position: absolute;\n  top: 0;\n  left: 0;\n  width: 100%;\n  height: 100%;\n  backface-visibility: hidden;\n  border-radius: 12px;\n  background: #f8f6f3; /* beige soft */\n  overflow: hidden;\n}\n.service-card-back {\n  transform: rotateY(180deg);\n  padding: 20px;\n  overflow-y: auto;\n}\n</style>\n",
        "storeOutMessages": true,
        "passthru": false,
        "resendOnRefresh": true,
        "templateScope": "local",
        "className": "",
        "x": 370,
        "y": 480,
        "wires": [
            [
                "f8bbfc96bfde14c3"
            ]
        ]
    },
    {
        "id": "f8bbfc96bfde14c3",
        "type": "switch",
        "z": "5dc8affbd505959b",
        "name": "",
        "property": "action",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "load_services",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "delete_services",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 550,
        "y": 480,
        "wires": [
            [
                "188eb6e2e6e2f35e"
            ],
            [
                "84f5904b1373663a"
            ]
        ]
    },
    {
        "id": "84f5904b1373663a",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Delete Service",
        "func": "// Prepara chiamata HTTP al catalog\nmsg.method = 'DELETE';\nmsg.url = `http://catalog:8001/service/${msg.serviceID}`;\nmsg.headers = { 'Content-Type': 'application/json' };\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 720,
        "y": 520,
        "wires": [
            [
                "46ab5d508832a188"
            ]
        ]
    },
    {
        "id": "46ab5d508832a188",
        "type": "http request",
        "z": "5dc8affbd505959b",
        "name": "",
        "method": "use",
        "ret": "obj",
        "paytoqs": "ignore",
        "url": "",
        "tls": "",
        "persist": false,
        "proxy": "",
        "insecureHTTPParser": false,
        "authType": "",
        "senderr": false,
        "headers": [],
        "x": 910,
        "y": 520,
        "wires": [
            [
                "8f38d03916b62ed6"
            ]
        ]
    },
    {
        "id": "8f38d03916b62ed6",
        "type": "function",
        "z": "5dc8affbd505959b",
        "name": "Handle Data",
        "func": "if (msg.statusCode === 200) {\n    return {\n        deleted: { deviceID: msg.payload.deviceID },\n        message: 'Device deleted successfully'\n    };\n} else {\n    return {\n        error: `Delete failed: ${msg.statusCode}`\n    };\n}",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1090,
        "y": 520,
        "wires": [
            [
                "b8dd8278782e8f27"
            ]
        ]
    },
    {
        "id": "a6e4d4577341e792",
        "type": "debug",
        "z": "5dc8affbd505959b",
        "name": "debug 14",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1280,
        "y": 380,
        "wires": []
    }
]